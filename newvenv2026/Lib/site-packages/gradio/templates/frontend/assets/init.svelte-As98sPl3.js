import*as d from"./svelte/svelte_internal_client.js";import{f as A,h as m,t as b,j}from"./i18n-CyvX8KmK.js";import{tick as f}from"./svelte/svelte_svelte.js";import{d as x}from"./index-tFQomdd2.js";import{a as w}from"./utils.svelte-Ceck75cM.js";import"./index-Dw8Uzof1.js";const R={walkthrough:"tabs",walkthroughstep:"tabitem"};class H{#i;#t;#e;reactive_formatter=t=>t;#r;client;#o=d.state();get root(){return d.get(this.#o)}set root(t){d.set(this.#o,t,!0)}root_untracked;#p=new Set;#n=new Set;#h=[];#a=new Map;#s=new Map;#l;component_ids;initial_tabs={};components_to_register=new Set;ready;ready_resolve;resolved=!1;#c=new Set;constructor(t,e,s,i,o,p,n){this.ready=new Promise(l=>{this.ready_resolve=l}),this.reactive_formatter=p,this.#r={...i,api_url:new URL(i.api_prefix,i.root).toString()},this.#i=t,this.#t=e,this.#e=s,this.root=this.create_node({id:e.id,children:[]},new Map,!0);for(const l of t)l.props.visible!=!1&&this.components_to_register.add(l.id);this.client=o,this.prepare();const a=t.reduce((l,c)=>(l.set(c.id,c),l),new Map);this.root.children=this.#t.children.map(l=>this.traverse(l,c=>this.create_node(c,a,!1,this.reactive_formatter))),this.component_ids=t.map(l=>l.id),this.initial_tabs={},g(this.root,this.initial_tabs),this.postprocess(this.root),this.#l=n,this.root_untracked=this.root}reload(t,e,s,i){this.#t=e,this.#i=t,this.#r={...i,api_url:new URL(i.api_prefix,i.root).toString()},this.#e=s,this.root=this.create_node({id:e.id,children:[]},new Map,!0);for(const p of t)p.props.visible!=!1&&this.components_to_register.add(p.id);this.prepare();const o=t.reduce((p,n)=>(p.set(n.id,n),p),new Map);this.root.children=this.#t.children.map(p=>this.traverse(p,n=>this.create_node(n,o,!1,this.reactive_formatter))),this.component_ids=t.map(p=>p.id),this.initial_tabs={},g(this.root,this.initial_tabs),this.postprocess(this.root)}register_component(t,e,s){this.#s.set(t,e),this.#a.set(t,s),this.components_to_register.delete(t),this.components_to_register.size===0&&!this.resolved&&(this.resolved=!0,this.ready_resolve())}prepare(){const[t,e]=A(this.#e);this.#p=t,this.#n=e}process(){}postprocess(t){this.root=this.traverse(t,[e=>h(e,this.#r.api_url),e=>U(e,this.components_to_register),e=>q(e,this.components_to_register),e=>z(e),e=>B(e,this.initial_tabs),e=>this.find_attached_events(e,this.#e),e=>$(e,this.components_to_register,this.#c)])}find_attached_events(t,e){const s=e.filter(i=>i.targets.find(([o])=>o===t.id)).map(i=>{const o=i.targets.find(([p])=>p===t.id);return o?o[1]:null}).filter(Boolean);return t.props.shared_props.attached_events=s,t}traverse(t,e){function s(i,o,p){const n=o(i);return"children"in i&&i.children.length>0&&(n.children=i.children?.map(a=>p(a,o))||[]),n}if(Array.isArray(e)){let i=t;for(const o of e)i=s(i,o,this.traverse.bind(this));return i}else return s(t,e,this.traverse.bind(this))}create_node(t,e,s=!1,i){let o;if(s?o={type:"column",id:t.id,props:{visible:!0,root:"",theme_mode:"light"},component_class_id:"column",key:null}:o=e.get(t.id),!o)throw new Error(`Component with ID ${t.id} not found`);i&&(o.props.i18n=i);const p=O(t.id,o.props,[this.#p,this.#n],this.client,this.#r.api_url,{...this.#r}),n=R[o.type]||o.type;return{id:t.id,type:n,props:p,children:[],show_progress_on:null,component_class_id:o.component_class_id||o.type,component:p.shared_props.visible!==!1?m(o.type,o.component_class_id,this.#r.api_url||""):null,key:o.key,rendered_in:o.rendered_in,documentation:o.documentation,original_visibility:p.shared_props.visible}}rerender(t,e){const s=t.reduce((p,n)=>(p.set(n.id,n),p),new Map),i=this.traverse(e,p=>this.create_node(p,s,!1,this.reactive_formatter)),o=_(this.root,i.id);if(!o)throw new Error("Rerender failed: root node not found in current tree");o.children=i.children}async update_visibility(t,e){t.children.forEach(s=>{const i=this.#s.get(s.id);i&&i(e),this.update_visibility(s,e)})}async update_state(t,e,s=!0){const i=_(this.root,t);let o=!1;s&&!i?.component&&(await f(),this.root=this.traverse(this.root,[a=>P(a,t,e.visible),a=>y(a,t,e.visible),a=>h(a,this.#r.api_url)]),await f(),o=!0);const p=this.#s.get(t);if(p)p&&p(e);else{const a=i?.props.props.value,l=E(e);i.props.shared_props={...i?.props.shared_props,...l.shared_props},i.props.props={...i?.props.props,...l.props},"value"in e&&!x(a,e.value)&&this.#l(t,"change",null)}if(!s||o)return;await f(),await this.update_visibility(i,e);const n=S(this.root,t);n&&y(n,t,e.visible)}async get_state(t){const e=this.#a.get(t),s=_(this.root,t);return!e&&!s?null:e?await e():s?Promise.resolve({value:s.props.props.value}):null}async render_previously_invisible_children(t){this.root=this.traverse(this.root,[e=>(e.id===t&&k(e,this.#c),e),e=>h(e,this.#r.api_url)])}}function k(r,t){r.props.shared_props.visible=t.has(r.id)?!0:r.props.shared_props.visible,r.children.forEach(e=>{k(e,t)})}function L(r,t,e){return t?t.reduce((s,i)=>(s[i]=async(...o)=>(o.length===1&&(o=o[0]),await e.component_server(r,i,o)),s),{}):{}}function E(r){const t={},e={};for(const s in r)if(s==="id"||s==="autoscroll")e[s]=r[s];else if(w.includes(s)){const i=s;t[i]=r[s]}else e[s]=r[s];return{shared_props:t,props:e}}function O(r,t,e,s,i,o={}){const{shared_props:p,props:n}=E(t);p.server=L(r,t.server_fns,s);for(const a in o)if(w.includes(a)){const l=a;p[l]=o[a]}else n[a]=o[a];return p.client=s,p.id=r,p.interactive=j(r,p.interactive,n.value,e),p.load_component=(a,l)=>m(a,"",i,l),p.visible=p.visible===void 0?!0:p.visible,p.loading_status={},{shared_props:p,props:n}}function h(r,t){if(r.props.shared_props.visible&&!r.component){const e={...r,component:m(r.type,r.component_class_id,t),children:[]};return r.children&&(e.children=r.children.map(s=>h(s,t))),e}else return r}function P(r,t,e){return r.id==t&&(r.props.shared_props.visible=e),r}function u(r,t){t.delete(r.id),r.children&&r.children.forEach(e=>u(e,t))}function U(r,t){return r.props.shared_props.visible!==!0&&u(r,t),r}function v(r,t){return r.props.shared_props.visible===!0&&(t.add(r.id),r.props.shared_props.visible=!1),r.children.forEach(e=>{v(e,t)}),r}function $(r,t,e){return r.type==="accordion"&&r.props.props.open===!1&&(u(r,t),r.children&&r.children.forEach(s=>{v(s,e)})),r.type==="tabs"&&r.children.forEach(s=>{s.type==="tabitem"&&s.props.props.id!==(r.props.props.selected||r.props.props.initial_tabs[0].id)&&(u(s,t),v(s,e))}),r}function q(r,t){return r.type==="form"&&r.children.every(s=>s.props.shared_props.visible===!1)&&(r.props.shared_props.visible=!1,t.delete(r.id)),r}function y(r,t,e){return r.type==="form"&&r.children.length&&r.children.some(s=>s.id===t)&&(e===!0?r.props.shared_props.visible=!0:!e&&r.children.length===1&&(r.props.shared_props.visible="hidden")),r}function z(r){const t=["description","info","title","placeholder","value","label"];for(const e of Object.keys(r.props.shared_props))t.includes(e)&&(r.props.shared_props[e]=b(r.props.shared_props[e]));for(const e of Object.keys(r.props.props))t.includes(e)&&(r.props.props[e]=b(r.props.props[e]));return r}function B(r,t){if(r.type==="tabs"&&r.id in t){const e=t[r.id].sort((s,i)=>s.order-i.order);r.props.props.initial_tabs=e}else r.type==="tabitem"&&(r.props.props.component_id=r.id);return r}function M(r,t,e,s){e!==null&&r.type==="tabitem"&&(e in t||(t[e]=[]),"id"in r.props.props||(r.props.props.id=r.id),t[e].push({label:r.props.shared_props.label,id:r.props.props.id,elem_id:r.props.shared_props.elem_id,visible:r.props.shared_props.visible,interactive:r.props.shared_props.interactive,scale:r.props.shared_props.scale||null,component_id:r.id}),r.props.props.order=s),r.children&&r.children.forEach((i,o)=>{M(i,t,r.type==="tabs"?r.id:null,r.type==="tabs"?o:null)})}function g(r,t){function e(s){"children"in s&&s.children.length>0&&s.children?.forEach(i=>M(i,t,s.type==="tabs"?s.id:null,null))}return e(r)}function _(r,t){if(r.id===t)return r;if(r.children)for(const e of r.children){const s=_(e,t);if(s)return s}return null}function S(r,t){if(r.children)for(const e of r.children){if(e.id===t)return r;const s=S(e,t);if(s)return s}return null}export{H as A};
