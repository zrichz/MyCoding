import{aw as _,M as l,d as p,Q as u,V as h,ax as f}from"./index-Dtj0WP_z.js";class r extends _{get _matrix(){return this._compose(),this._localMatrix}set _matrix(t){t.updateFlag===this._localMatrix.updateFlag&&!this._needToCompose||(this._needToCompose=!1,this._localMatrix.copyFrom(t),this._markAsDirtyAndDecompose())}constructor(t,i,e=null,s=null,o=null,n=null,a=null){super(t,i.getScene(),!1),this.name=t,this.children=[],this.animations=[],this._index=null,this._scalingDeterminant=1,this._needToDecompose=!0,this._needToCompose=!1,this._linkedTransformNode=null,this._waitingTransformNodeId=null,this._skeleton=i,this._localMatrix=s?.clone()??l.Identity(),this._restMatrix=o??this._localMatrix.clone(),this._bindMatrix=n??this._localMatrix.clone(),this._index=a,this._absoluteMatrix=new l,this._absoluteBindMatrix=new l,this._absoluteInverseBindMatrix=new l,this._finalMatrix=new l,i.bones.push(this),this.setParent(e,!1),this._updateAbsoluteBindMatrices()}getClassName(){return"Bone"}getSkeleton(){return this._skeleton}get parent(){return this._parentNode}getParent(){return this.parent}getChildren(){return this.children}getIndex(){return this._index===null?this.getSkeleton().bones.indexOf(this):this._index}set parent(t){this.setParent(t)}setParent(t,i=!0){if(this.parent!==t){if(this.parent){const e=this.parent.children.indexOf(this);e!==-1&&this.parent.children.splice(e,1)}this._parentNode=t,this.parent&&this.parent.children.push(this),i&&this._updateAbsoluteBindMatrices(),this.markAsDirty()}}getLocalMatrix(){return this._compose(),this._localMatrix}getBindMatrix(){return this._bindMatrix}getBaseMatrix(){return this.getBindMatrix()}getRestMatrix(){return this._restMatrix}getRestPose(){return this.getRestMatrix()}setRestMatrix(t){this._restMatrix.copyFrom(t)}setRestPose(t){this.setRestMatrix(t)}getBindPose(){return this.getBindMatrix()}setBindMatrix(t){this.updateMatrix(t)}setBindPose(t){this.setBindMatrix(t)}getFinalMatrix(){return this._finalMatrix}getWorldMatrix(){return this.getFinalMatrix()}returnToRest(){if(this._linkedTransformNode){const t=p.Vector3[0],i=p.Quaternion[0],e=p.Vector3[1];this.getRestMatrix().decompose(t,i,e),this._linkedTransformNode.position.copyFrom(e),this._linkedTransformNode.rotationQuaternion=this._linkedTransformNode.rotationQuaternion??u.Identity(),this._linkedTransformNode.rotationQuaternion.copyFrom(i),this._linkedTransformNode.scaling.copyFrom(t)}else this._matrix=this._restMatrix}getAbsoluteInverseBindMatrix(){return this._absoluteInverseBindMatrix}getInvertedAbsoluteTransform(){return this.getAbsoluteInverseBindMatrix()}getAbsoluteMatrix(){return this._skeleton.computeAbsoluteMatrices(),this._absoluteMatrix}getAbsoluteTransform(){return this.getAbsoluteMatrix()}linkTransformNode(t){this._linkedTransformNode&&this._skeleton._numBonesWithLinkedTransformNode--,this._linkedTransformNode=t,this._linkedTransformNode&&this._skeleton._numBonesWithLinkedTransformNode++}getTransformNode(){return this._linkedTransformNode}get position(){return this._decompose(),this._localPosition}set position(t){this._decompose(),this._localPosition.copyFrom(t),this._markAsDirtyAndCompose()}get rotation(){return this.getRotation()}set rotation(t){this.setRotation(t)}get rotationQuaternion(){return this._decompose(),this._localRotation}set rotationQuaternion(t){this.setRotationQuaternion(t)}get scaling(){return this.getScale()}set scaling(t){this.setScale(t)}get animationPropertiesOverride(){return this._skeleton.animationPropertiesOverride}_decompose(){this._needToDecompose&&(this._needToDecompose=!1,this._localScaling||(this._localScaling=h.Zero(),this._localRotation=u.Zero(),this._localPosition=h.Zero()),this._localMatrix.decompose(this._localScaling,this._localRotation,this._localPosition))}_compose(){if(this._needToCompose){if(!this._localScaling){this._needToCompose=!1;return}this._needToCompose=!1,l.ComposeToRef(this._localScaling,this._localRotation,this._localPosition,this._localMatrix)}}updateMatrix(t,i=!0,e=!0){this._bindMatrix.copyFrom(t),i&&this._updateAbsoluteBindMatrices(),e?this._matrix=t:this.markAsDirty()}_updateAbsoluteBindMatrices(t,i=!0){if(t||(t=this._bindMatrix),this.parent?t.multiplyToRef(this.parent._absoluteBindMatrix,this._absoluteBindMatrix):this._absoluteBindMatrix.copyFrom(t),this._absoluteBindMatrix.invertToRef(this._absoluteInverseBindMatrix),i)for(let e=0;e<this.children.length;e++)this.children[e]._updateAbsoluteBindMatrices();this._scalingDeterminant=this._absoluteBindMatrix.determinant()<0?-1:1}markAsDirty(){return this._currentRenderId++,this._childUpdateId++,this._skeleton._markAsDirty(),this}_markAsDirtyAndCompose(){this.markAsDirty(),this._needToCompose=!0}_markAsDirtyAndDecompose(){this.markAsDirty(),this._needToDecompose=!0}_updatePosition(t,i=0,e,s=!0){const o=this.getLocalMatrix();if(i==0)s?(o.addAtIndex(12,t.x),o.addAtIndex(13,t.y),o.addAtIndex(14,t.z)):o.setTranslationFromFloats(t.x,t.y,t.z);else{const n=r._TmpMats[0],a=r._TmpVecs[0];this.parent?(n.copyFrom(this.parent.getAbsoluteMatrix()),e&&n.multiplyToRef(e.getWorldMatrix(),n)):l.IdentityToRef(n),s&&n.setTranslationFromFloats(0,0,0),n.invert(),h.TransformCoordinatesToRef(t,n,a),s?(o.addAtIndex(12,a.x),o.addAtIndex(13,a.y),o.addAtIndex(14,a.z)):o.setTranslationFromFloats(a.x,a.y,a.z)}this._markAsDirtyAndDecompose()}translate(t,i=0,e){this._updatePosition(t,i,e,!0)}setPosition(t,i=0,e){this._updatePosition(t,i,e,!1)}setAbsolutePosition(t,i){this.setPosition(t,1,i)}scale(t,i,e,s=!1){const o=this.getLocalMatrix(),n=r._TmpMats[0];l.ScalingToRef(t,i,e,n),n.multiplyToRef(o,o),n.invert();for(const a of this.children){const c=a.getLocalMatrix();c.multiplyToRef(n,c),c.multiplyAtIndex(12,t),c.multiplyAtIndex(13,i),c.multiplyAtIndex(14,e),a._markAsDirtyAndDecompose()}if(this._markAsDirtyAndDecompose(),s)for(const a of this.children)a.scale(t,i,e,s)}setScale(t){this._decompose(),this._localScaling.copyFrom(t),this._markAsDirtyAndCompose()}getScale(){return this._decompose(),this._localScaling}getScaleToRef(t){this._decompose(),t.copyFrom(this._localScaling)}setYawPitchRoll(t,i,e,s=0,o){if(s===0){const c=r._TmpQuat;u.RotationYawPitchRollToRef(t,i,e,c),this.setRotationQuaternion(c,s,o);return}const n=r._TmpMats[0];if(!this._getAbsoluteInverseMatrixUnscaledToRef(n,o))return;const a=r._TmpMats[1];l.RotationYawPitchRollToRef(t,i,e,a),n.multiplyToRef(a,a),this._rotateWithMatrix(a,s,o)}rotate(t,i,e=0,s){const o=r._TmpMats[0];o.setTranslationFromFloats(0,0,0),l.RotationAxisToRef(t,i,o),this._rotateWithMatrix(o,e,s)}setAxisAngle(t,i,e=0,s){if(e===0){const a=r._TmpQuat;u.RotationAxisToRef(t,i,a),this.setRotationQuaternion(a,e,s);return}const o=r._TmpMats[0];if(!this._getAbsoluteInverseMatrixUnscaledToRef(o,s))return;const n=r._TmpMats[1];l.RotationAxisToRef(t,i,n),o.multiplyToRef(n,n),this._rotateWithMatrix(n,e,s)}setRotation(t,i=0,e){this.setYawPitchRoll(t.y,t.x,t.z,i,e)}setRotationQuaternion(t,i=0,e){if(i===0){this._decompose(),this._localRotation.copyFrom(t),this._markAsDirtyAndCompose();return}const s=r._TmpMats[0];if(!this._getAbsoluteInverseMatrixUnscaledToRef(s,e))return;const o=r._TmpMats[1];l.FromQuaternionToRef(t,o),s.multiplyToRef(o,o),this._rotateWithMatrix(o,i,e)}setRotationMatrix(t,i=0,e){if(i===0){const n=r._TmpQuat;u.FromRotationMatrixToRef(t,n),this.setRotationQuaternion(n,i,e);return}const s=r._TmpMats[0];if(!this._getAbsoluteInverseMatrixUnscaledToRef(s,e))return;const o=r._TmpMats[1];o.copyFrom(t),s.multiplyToRef(t,o),this._rotateWithMatrix(o,i,e)}_rotateWithMatrix(t,i=0,e){const s=this.getLocalMatrix(),o=s.m[12],n=s.m[13],a=s.m[14],c=this.getParent(),m=r._TmpMats[3],d=r._TmpMats[4];c&&i==1?(e?(m.copyFrom(e.getWorldMatrix()),c.getAbsoluteMatrix().multiplyToRef(m,m)):m.copyFrom(c.getAbsoluteMatrix()),d.copyFrom(m),d.invert(),s.multiplyToRef(m,s),s.multiplyToRef(t,s),s.multiplyToRef(d,s)):i==1&&e?(m.copyFrom(e.getWorldMatrix()),d.copyFrom(m),d.invert(),s.multiplyToRef(m,s),s.multiplyToRef(t,s),s.multiplyToRef(d,s)):s.multiplyToRef(t,s),s.setTranslationFromFloats(o,n,a),this._markAsDirtyAndDecompose()}_getAbsoluteInverseMatrixUnscaledToRef(t,i){const e=r._TmpMats[2];return t.copyFrom(this.getAbsoluteMatrix()),i?(t.multiplyToRef(i.getWorldMatrix(),t),l.ScalingToRef(i.scaling.x,i.scaling.y,i.scaling.z,e)):l.IdentityToRef(e),t.invert(),isNaN(t.m[0])?!1:(e.multiplyAtIndex(0,this._scalingDeterminant),t.multiplyToRef(e,t),!0)}getPosition(t=0,i=null){const e=h.Zero();return this.getPositionToRef(t,i,e),e}getPositionToRef(t=0,i,e){if(t==0){const s=this.getLocalMatrix();e.x=s.m[12],e.y=s.m[13],e.z=s.m[14]}else{const s=r._TmpMats[0].copyFrom(this.getAbsoluteMatrix());i&&s.multiplyToRef(i.getWorldMatrix(),s),e.x=s.m[12],e.y=s.m[13],e.z=s.m[14]}}getAbsolutePosition(t=null){const i=h.Zero();return this.getPositionToRef(1,t,i),i}getAbsolutePositionToRef(t,i){this.getPositionToRef(1,t,i)}computeAbsoluteMatrices(){if(this._compose(),this.parent)this._localMatrix.multiplyToRef(this.parent._absoluteMatrix,this._absoluteMatrix);else{this._absoluteMatrix.copyFrom(this._localMatrix);const e=this._skeleton.getPoseMatrix();e&&this._absoluteMatrix.multiplyToRef(e,this._absoluteMatrix)}const t=this.children,i=t.length;for(let e=0;e<i;e++)t[e].computeAbsoluteMatrices()}computeAbsoluteTransforms(){this.computeAbsoluteMatrices()}getDirection(t,i=null){const e=h.Zero();return this.getDirectionToRef(t,i,e),e}getDirectionToRef(t,i=null,e){const s=r._TmpMats[0].copyFrom(this.getAbsoluteMatrix());i&&s.multiplyToRef(i.getWorldMatrix(),s),h.TransformNormalToRef(t,s,e),e.normalize()}getRotation(t=0,i=null){const e=h.Zero();return this.getRotationToRef(t,i,e),e}getRotationToRef(t=0,i=null,e){const s=r._TmpQuat;this.getRotationQuaternionToRef(t,i,s),s.toEulerAnglesToRef(e)}getRotationQuaternion(t=0,i=null){const e=u.Identity();return this.getRotationQuaternionToRef(t,i,e),e}getRotationQuaternionToRef(t=0,i=null,e){if(t==0)this._decompose(),e.copyFrom(this._localRotation);else{const s=r._TmpMats[0],o=this.getAbsoluteMatrix();i?o.multiplyToRef(i.getWorldMatrix(),s):s.copyFrom(o),s.multiplyAtIndex(0,this._scalingDeterminant),s.multiplyAtIndex(1,this._scalingDeterminant),s.multiplyAtIndex(2,this._scalingDeterminant),s.decompose(void 0,e,void 0)}}getRotationMatrix(t=0,i){const e=l.Identity();return this.getRotationMatrixToRef(t,i,e),e}getRotationMatrixToRef(t=0,i,e){if(t==0)this.getLocalMatrix().getRotationMatrixToRef(e);else{const s=r._TmpMats[0],o=this.getAbsoluteMatrix();i?o.multiplyToRef(i.getWorldMatrix(),s):s.copyFrom(o),s.multiplyAtIndex(0,this._scalingDeterminant),s.multiplyAtIndex(1,this._scalingDeterminant),s.multiplyAtIndex(2,this._scalingDeterminant),s.getRotationMatrixToRef(e)}}getAbsolutePositionFromLocal(t,i=null){const e=h.Zero();return this.getAbsolutePositionFromLocalToRef(t,i,e),e}getAbsolutePositionFromLocalToRef(t,i=null,e){const s=r._TmpMats[0].copyFrom(this.getAbsoluteMatrix());i&&s.multiplyToRef(i.getWorldMatrix(),s),h.TransformCoordinatesToRef(t,s,e)}getLocalPositionFromAbsolute(t,i=null){const e=h.Zero();return this.getLocalPositionFromAbsoluteToRef(t,i,e),e}getLocalPositionFromAbsoluteToRef(t,i=null,e){const s=r._TmpMats[0].copyFrom(this.getAbsoluteMatrix());i&&s.multiplyToRef(i.getWorldMatrix(),s),s.invert(),h.TransformCoordinatesToRef(t,s,e)}setCurrentPoseAsRest(){this.setRestMatrix(this.getLocalMatrix())}dispose(){this._linkedTransformNode=null;const t=this._skeleton.bones.indexOf(this);if(t!==-1&&this._skeleton.bones.splice(t,1),this._parentNode&&this._parentNode.children){const i=this._parentNode.children,e=i.indexOf(this);e!==-1&&i.splice(e,1)}super.dispose()}}r._TmpVecs=f(2,h.Zero);r._TmpQuat=u.Identity();r._TmpMats=f(5,l.Identity);export{r as B};
