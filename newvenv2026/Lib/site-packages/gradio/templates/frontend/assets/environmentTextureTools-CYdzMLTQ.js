const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./rgbdDecode.fragment-iayH4Kd1.js","./index-Dtj0WP_z.js","./index-Dw8Uzof1.js","./index-qRhMeKhs.css","./helperFunctions-Cj61g9Q2.js","./rgbdDecode.fragment-BBkeN1xS.js","./helperFunctions-vhBENDhA.js"])))=>i.map(i=>d[i]);
import{_ as D}from"./index-Dw8Uzof1.js";import{L as G,aF as P,V as d,I as C,B as O,e as z,aG as V,aH as k}from"./index-Dtj0WP_z.js";import"./dumpTools-CRDzJO86.js";const v="image/png",E=2,S=[134,22,135,150,246,214,150,54];function J(e){const n=new DataView(e.buffer,e.byteOffset,e.byteLength);let r=0;for(let o=0;o<S.length;o++)if(n.getUint8(r++)!==S[o])return G.Error("Not a babylon environment map"),null;let t="",i=0;for(;i=n.getUint8(r++);)t+=String.fromCharCode(i);let a=JSON.parse(t);return a=R(a),a.binaryDataPosition=r,a.specular&&(a.specular.lodGenerationScale=a.specular.lodGenerationScale||.8),a}function R(e){if(e.version>E)throw new Error(`Unsupported babylon environment map version "${e.version}". Latest supported version is "${E}".`);return e.version===2||(e={...e,version:2,imageType:v}),e}function H(e,n){n=R(n);const r=n.specular;let t=Math.log2(n.width);if(t=Math.round(t)+1,r.mipmaps.length!==6*t)throw new Error(`Unsupported specular mipmaps number "${r.mipmaps.length}"`);const i=new Array(t);for(let a=0;a<t;a++){i[a]=new Array(6);for(let o=0;o<6;o++){const l=r.mipmaps[a*6+o];i[a][o]=new Uint8Array(e.buffer,e.byteOffset+n.binaryDataPosition+l.position,l.length)}}return i}function Y(e,n){n=R(n);const r=new Array(6),t=n.irradiance?.irradianceTexture;if(t){if(t.faces.length!==6)throw new Error(`Incorrect irradiance texture faces number "${t.faces.length}"`);for(let i=0;i<6;i++){const a=t.faces[i];r[i]=new Uint8Array(e.buffer,e.byteOffset+n.binaryDataPosition+a.position,a.length)}}return r}function q(e,n,r){r=R(r);const t=r.specular;if(!t)return Promise.resolve([]);e._lodGenerationScale=t.lodGenerationScale;const i=[],a=H(n,r);i.push(F(e,a,r.imageType));const o=r.irradiance?.irradianceTexture;if(o){const l=Y(n,r);let p=null;r.irradiance?.irradianceTexture?.dominantDirection&&(p=d.FromArray(r.irradiance.irradianceTexture.dominantDirection)),i.push($(e,l,o.size,r.imageType,p))}return Promise.all(i)}async function U(e,n,r,t,i,a,o,l,p,m,w){return await new Promise((y,I)=>{if(r){const g=n.createTexture(null,!0,!0,null,1,null,s=>{I(s)},e);t?.onEffectCreatedObservable.addOnce(s=>{s.executeWhenCompiled(()=>{t.externalTextureSamplerBinding=!0,t.onApply=c=>{c._bindTexture("textureSampler",g),c.setFloat2("scale",1,n._features.needsInvertingBitmap&&e instanceof ImageBitmap?-1:1)},n.scenes.length&&(n.scenes[0].postProcessManager.directRender([t],m,!0,a,o),n.restoreDefaultFramebuffer(),g.dispose(),URL.revokeObjectURL(i),y())})})}else{if(n._uploadImageToTexture(w,e,a,o),l){const g=p[o];g&&n._uploadImageToTexture(g._texture,e,a,0)}y()}})}async function F(e,n,r=v){const t=e.getEngine();e.format=5,e.type=0,e.generateMipMaps=!0,e._cachedAnisotropicFilteringLevel=null,t.updateTextureSamplingMode(3,e),await B(e,n,!0,r),e.isReady=!0}async function $(e,n,r,t=v,i=null){const a=e.getEngine(),o=new C(a,5),l=new O(a,o);e._irradianceTexture=l,l._dominantDirection=i,o.isCube=!0,o.format=5,o.type=0,o.generateMipMaps=!0,o._cachedAnisotropicFilteringLevel=null,o.generateMipMaps=!0,o.width=r,o.height=r,a.updateTextureSamplingMode(3,o),await B(o,[n],!1,t),a.generateMipMapsForCubemap(o),o.isReady=!0}async function B(e,n,r,t=v){if(!z.IsExponentOfTwo(e.width))throw new Error("Texture size must be a power of two");const i=V(e.width)+1,a=e.getEngine();let o=!1,l=!1,p=null,m=null,w=null;const y=a.getCaps();y.textureLOD?a._features.supportRenderAndCopyToLodForFloatTextures?y.textureHalfFloatRender&&y.textureHalfFloatLinearFiltering?(o=!0,e.type=2):y.textureFloatRender&&y.textureFloatLinearFiltering&&(o=!0,e.type=1):o=!1:(o=!1,l=r);let I=0;if(o)a.isWebGPU?(I=1,await D(()=>import("./rgbdDecode.fragment-iayH4Kd1.js"),__vite__mapDeps([0,1,2,3,4]),import.meta.url)):await D(()=>import("./rgbdDecode.fragment-BBkeN1xS.js"),__vite__mapDeps([5,1,2,3,6]),import.meta.url),p=new k("rgbdDecode","rgbdDecode",null,null,1,null,3,a,!1,void 0,e.type,void 0,null,!1,void 0,I),e._isRGBD=!1,e.invertY=!1,m=a.createRenderTargetCubeTexture(e.width,{generateDepthBuffer:!1,generateMipMaps:!0,generateStencilBuffer:!1,samplingMode:3,type:e.type,format:5});else if(e._isRGBD=!0,e.invertY=!0,l){w={};const c=e._lodGenerationScale,_=e._lodGenerationOffset;for(let u=0;u<3;u++){const b=1-u/2,f=_,L=(i-1)*c+_,M=f+(L-f)*b,A=Math.round(Math.min(Math.max(M,0),L)),x=new C(a,2);x.isCube=!0,x.invertY=!0,x.generateMipMaps=!1,a.updateTextureSamplingMode(2,x);const T=new O(null);switch(T._isCube=!0,T._texture=x,w[A]=T,u){case 0:e._lodTextureLow=T;break;case 1:e._lodTextureMid=T;break;case 2:e._lodTextureHigh=T;break}}}const g=[];for(let s=0;s<n.length;s++)for(let c=0;c<6;c++){const _=n[s][c],u=new Blob([_],{type:t}),h=URL.createObjectURL(u);let b;if(a._features.forceBitmapOverHTMLImageElement)b=a.createImageBitmap(u,{premultiplyAlpha:"none"}).then(async f=>await U(f,a,o,p,h,c,s,l,w,m,e));else{const f=new Image;f.src=h,b=new Promise((L,M)=>{f.onload=()=>{U(f,a,o,p,h,c,s,l,w,m,e).then(()=>L()).catch(A=>{M(A)})},f.onerror=A=>{M(A)}})}g.push(b)}if(await Promise.all(g),n.length<i){let s;const c=Math.pow(2,i-1-n.length),_=c*c*4;switch(e.type){case 0:{s=new Uint8Array(_);break}case 2:{s=new Uint16Array(_);break}case 1:{s=new Float32Array(_);break}}for(let u=n.length;u<i;u++)for(let h=0;h<6;h++)a._uploadArrayBufferViewToTexture(m?.texture||e,s,h,u)}if(m){const s=e._irradianceTexture;e._irradianceTexture=null,a._releaseTexture(e),m._swapAndDie(e),e._irradianceTexture=s}p&&p.dispose(),l&&(e._lodTextureHigh&&e._lodTextureHigh._texture&&(e._lodTextureHigh._texture.isReady=!0),e._lodTextureMid&&e._lodTextureMid._texture&&(e._lodTextureMid._texture.isReady=!0),e._lodTextureLow&&e._lodTextureLow._texture&&(e._lodTextureLow._texture.isReady=!0))}function K(e,n){n=R(n);const r=n.irradiance;if(!r)return;const t=new P;d.FromArrayToRef(r.x,0,t.x),d.FromArrayToRef(r.y,0,t.y),d.FromArrayToRef(r.z,0,t.z),d.FromArrayToRef(r.xx,0,t.xx),d.FromArrayToRef(r.yy,0,t.yy),d.FromArrayToRef(r.zz,0,t.zz),d.FromArrayToRef(r.yz,0,t.yz),d.FromArrayToRef(r.zx,0,t.zx),d.FromArrayToRef(r.xy,0,t.xy),e._sphericalPolynomial=t}function Q(e,n,r,t,i){const a=e.getEngine().createRawCubeTexture(null,e.width,e.format,e.type,e.generateMipMaps,e.invertY,e.samplingMode,e._compression),o=F(a,n).then(()=>e);return e.onRebuildCallback=l=>({proxy:o,isReady:!0,isAsync:!0}),e._source=13,e._bufferViewArrayArray=n,e._lodGenerationScale=t,e._lodGenerationOffset=i,e._sphericalPolynomial=r,F(e,n).then(()=>(e.isReady=!0,e))}export{J as G,K as U,Q as _,q as a};
