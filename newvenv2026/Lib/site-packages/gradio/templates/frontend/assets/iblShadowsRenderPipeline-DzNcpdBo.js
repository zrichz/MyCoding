const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./iblVoxelGrid3dDebug.fragment-CIqoxssG.js","./index-Dtj0WP_z.js","./index-Dw8Uzof1.js","./index-qRhMeKhs.css","./iblVoxelGrid3dDebug.fragment-l7vit_qv.js","./copyTexture3DLayerToTexture.fragment-hhRcaPcs.js","./copyTexture3DLayerToTexture.fragment-CMLT4HIq.js","./iblCombineVoxelGrids.fragment-D3cFWw4A.js","./iblCombineVoxelGrids.fragment-DSd3nhzh.js","./iblGenerateVoxelMip.fragment-Du06dfzY.js","./iblGenerateVoxelMip.fragment-BiWKxyac.js","./iblVoxelGrid.fragment-DSut4gxZ.js","./iblVoxelGrid.vertex-CD5B4bTZ.js","./morphTargetsVertexDeclaration-DK2xs3Bb.js","./iblVoxelGrid.fragment-DqIsPH-b.js","./iblVoxelGrid.vertex-Bo-k98q7.js","./iblVoxelSlabDebug.fragment-CRan6iou.js","./iblVoxelSlabDebug.vertex-BqPrydof.js","./iblVoxelSlabDebug.fragment-CzIaoyrK.js","./iblVoxelSlabDebug.vertex-CbTtGpgR.js","./iblShadowDebug.fragment-CZC809qZ.js","./iblShadowDebug.fragment-CjxLqNHB.js","./iblShadowVoxelTracing.fragment-4S9qIv4P.js","./iblShadowVoxelTracing.fragment-C_9FoJ7d.js","./iblShadowSpatialBlur.fragment-oFXyvYXL.js","./iblShadowSpatialBlur.fragment-DI3lbwxW.js","./iblShadowAccumulation.fragment-D8HyPjwE.js","./iblShadowAccumulation.fragment-CTwX4MIS.js","./pass.fragment-CYzqJzMR.js","./pass.fragment-B0nXoPvp.js","./iblShadowGBufferDebug.fragment-Da0lwYuA.js","./iblShadowGBufferDebug.fragment-DWk7EThh.js"])))=>i.map(i=>d[i]);
import{_ as o}from"./index-Dw8Uzof1.js";import{aS as p,aH as w,bh as B,O as R,M as b,aq as f,L as _,aK as L,aL as N,a as x,bj as D,V as g,by as F,bz as y,ak as U,_ as V,s as C,am as H,R as X,E as Y,Q as I}from"./index-Dtj0WP_z.js";import{ShaderMaterial as A}from"./shaderMaterial-PBpsr6Jq.js";import{M as k,G as d}from"./geometryBufferRenderer-DM0dDb41.js";import{P}from"./iblCdfGenerator-CFRZO3nP.js";import{P as Z,a as j}from"./postProcessRenderEffect-CIjDuAwg.js";import{R as q}from"./rawTexture-BE3nsnOe.js";import{OpenPBRMaterial as M}from"./openpbrMaterial-Bt5gnR8F.js";import{S as Q}from"./standardMaterial-ByOmGQsu.js";import"./geometryBufferRendererSceneComponent-DPQhlEwz.js";import"./iblCdfGeneratorSceneComponent-Vf86x8k_.js";import"./svelte/svelte_svelte.js";import"./svelte/svelte_animate.js";import"./svelte/svelte_attachments.js";import"./svelte/svelte_easing.js";import"./svelte/svelte_internal_client.js";import"./svelte/svelte_internal_flags_async.js";import"./svelte/svelte_internal_flags_legacy.js";import"./svelte/svelte_internal_flags_tracing.js";import"./svelte/svelte_internal_server.js";import"./svelte/svelte_legacy.js";import"./svelte/svelte_motion.js";import"./svelte/svelte_reactivity.js";import"./svelte/svelte_reactivity_window.js";import"./svelte/svelte_server.js";import"./svelte/svelte_store.js";import"./svelte/svelte_transition.js";import"./svelte/svelte_events.js";import"./engine.multiRender-bUTR95iA.js";import"./bumpFragment-B0cXzddS.js";import"./helperFunctions-vhBENDhA.js";import"./sceneUboDeclaration-CuFGPF1s.js";import"./bumpVertex-CdN-KpKT.js";class K{getVoxelGrid(){return this._engine.isWebGPU?this._voxelGrid:this._triPlanarVoxelization?this._combinedVoxelGridPT:this._voxelGridZaxis}getDebugPassPP(){return this._voxelDebugPass||this._createDebugPass(),this._voxelDebugPass}get triPlanarVoxelization(){return this._triPlanarVoxelization}set triPlanarVoxelization(e){if(this._engine.isWebGPU){this._triPlanarVoxelization=!0;return}this._triPlanarVoxelization!==e&&(this._triPlanarVoxelization=e,this._disposeVoxelTextures(),this._createTextures())}setWorldScaleMatrix(e){this._invWorldScaleMatrix=e}isVoxelizationInProgress(){return this._voxelizationInProgress}get voxelResolutionExp(){return this._voxelResolutionExp}set voxelResolutionExp(e){this._voxelResolutionExp===e&&this._voxelGridZaxis||(this._voxelResolutionExp=Math.round(Math.min(Math.max(e,3),9)),this._voxelResolution=Math.pow(2,this._voxelResolutionExp),this._disposeVoxelTextures(),this._createTextures())}set voxelDebugAxis(e){this._voxelDebugAxis=e}get voxelDebugAxis(){return this._voxelDebugAxis}setDebugDisplayParams(e,t,s,i){this._debugSizeParams.set(e,t,s,i)}setDebugMipNumber(e){this._debugMipNumber=e}get debugPassName(){return this._debugPassName}get voxelDebugEnabled(){return this._voxelDebugEnabled}set voxelDebugEnabled(e){this._voxelDebugEnabled!==e&&(this._voxelDebugEnabled=e,e&&(this._voxelSlabDebugRT=new p("voxelSlabDebug",{width:this._engine.getRenderWidth(),height:this._engine.getRenderHeight()},this._scene,{generateDepthBuffer:!0,generateMipMaps:!1,type:0,format:5,samplingMode:1}),this._voxelSlabDebugRT.noPrePassRenderer=!0),this._voxelSlabDebugRT&&this._removeVoxelRTs([this._voxelSlabDebugRT]),this._voxelDebugEnabled?(this._addRTsForRender([this._voxelSlabDebugRT],this._includedMeshes,this._voxelDebugAxis,1,!0),this._setDebugBindingsBound=this._setDebugBindings.bind(this),this._scene.onBeforeRenderObservable.add(this._setDebugBindingsBound)):this._scene.onBeforeRenderObservable.removeCallback(this._setDebugBindingsBound))}_createDebugPass(){const e=this._engine.isWebGPU;if(!this._voxelDebugPass){const t={width:this._engine.getRenderWidth(),height:this._engine.getRenderHeight(),textureFormat:5,textureType:0,samplingMode:1,uniforms:["sizeParams","mipNumber"],samplers:["voxelTexture","voxelSlabTexture"],engine:this._engine,reusable:!1,shaderLanguage:e?1:0,extraInitializations:(s,i)=>{s?i.push(o(()=>import("./iblVoxelGrid3dDebug.fragment-CIqoxssG.js"),__vite__mapDeps([0,1,2,3]),import.meta.url)):i.push(o(()=>import("./iblVoxelGrid3dDebug.fragment-l7vit_qv.js"),__vite__mapDeps([4,1,2,3]),import.meta.url))}};this._voxelDebugPass=new w(this.debugPassName,"iblVoxelGrid3dDebug",t),this._voxelDebugPass.onApplyObservable.add(s=>{this._voxelDebugAxis===0?s.setTexture("voxelTexture",this._voxelGridXaxis):this._voxelDebugAxis===1?s.setTexture("voxelTexture",this._voxelGridYaxis):this._voxelDebugAxis===2?s.setTexture("voxelTexture",this._voxelGridZaxis):s.setTexture("voxelTexture",this.getVoxelGrid()),s.setTexture("voxelSlabTexture",this._voxelSlabDebugRT),s.setVector4("sizeParams",this._debugSizeParams),s.setFloat("mipNumber",this._debugMipNumber)})}}constructor(e,t,s=6,i=!0){this._voxelMrtsXaxis=[],this._voxelMrtsYaxis=[],this._voxelMrtsZaxis=[],this._voxelClearColor=new B(0,0,0,1),this.onVoxelizationCompleteObservable=new R,this._renderTargets=[],this._triPlanarVoxelization=!0,this._voxelizationInProgress=!1,this._invWorldScaleMatrix=b.Identity(),this._voxelResolution=64,this._voxelResolutionExp=6,this._mipArray=[],this._voxelDebugEnabled=!1,this._voxelDebugAxis=-1,this._debugSizeParams=new f(0,0,0,0),this._includedMeshes=[],this._debugMipNumber=0,this._debugPassName="Voxelization Debug Pass",this._scene=e,this._engine=e.getEngine(),this._triPlanarVoxelization=this._engine.isWebGPU||i,this._engine.getCaps().drawBuffersExtension||_.Error("Can't do voxel rendering without the draw buffers extension.");const n=this._engine.isWebGPU;this._maxDrawBuffers=this._engine.getCaps().maxDrawBuffers||0,this._copyMipEffectRenderer=new L(this._engine),this._copyMipEffectWrapper=new N({engine:this._engine,fragmentShader:"copyTexture3DLayerToTexture",useShaderStore:!0,uniformNames:["layerNum"],samplerNames:["textureSampler"],shaderLanguage:n?1:0,extraInitializationsAsync:async()=>{n?await o(()=>import("./copyTexture3DLayerToTexture.fragment-hhRcaPcs.js"),__vite__mapDeps([5,1,2,3]),import.meta.url):await o(()=>import("./copyTexture3DLayerToTexture.fragment-CMLT4HIq.js"),__vite__mapDeps([6,1,2,3]),import.meta.url)}}),this.voxelResolutionExp=s}_generateMipMaps(){const e=Math.ceil(Math.log2(this._voxelResolution));for(let t=1;t<e+1;t++)this._generateMipMap(t)}_generateMipMap(e){const t=this._mipArray[e-1];t&&(t.setTexture("srcMip",e===1?this.getVoxelGrid():this._mipArray[e-2]),t.render())}_copyMipMaps(){const e=Math.ceil(Math.log2(this._voxelResolution));for(let t=1;t<e+1;t++)this._copyMipMap(t)}_copyMipMap(e){const t=this._mipArray[e-1];if(!t)return;const s=this.getVoxelGrid();let i;if(s instanceof p&&s.renderTarget?i=s.renderTarget:i=s._rtWrapper,i){this._copyMipEffectRenderer.saveStates();const n=t.getSize().width;for(let r=0;r<n;r++)this._engine.bindFramebuffer(i,0,n,n,!0,e,r),this._copyMipEffectRenderer.applyEffectWrapper(this._copyMipEffectWrapper),this._copyMipEffectWrapper.effect.setTexture("textureSampler",t),this._copyMipEffectWrapper.effect.setInt("layerNum",r),this._copyMipEffectRenderer.draw(),this._engine.unBindFramebuffer(i,!0);this._copyMipEffectRenderer.restoreStates()}}_computeNumberOfSlabs(){return Math.ceil(this._voxelResolution/this._maxDrawBuffers)}_createTextures(){const e=this._engine.isWebGPU,t={width:this._voxelResolution,height:this._voxelResolution,depth:this._voxelResolution},s={generateDepthBuffer:!1,generateMipMaps:!1,type:0,format:5,samplingMode:1},i=this._computeNumberOfSlabs(),n={generateDepthBuffer:!1,generateMipMaps:!0,type:0,format:6,samplingMode:4,shaderLanguage:e?1:0,extraInitializationsAsync:async()=>{e?await o(()=>import("./iblCombineVoxelGrids.fragment-D3cFWw4A.js"),__vite__mapDeps([7,1,2,3]),import.meta.url):await o(()=>import("./iblCombineVoxelGrids.fragment-DSd3nhzh.js"),__vite__mapDeps([8,1,2,3]),import.meta.url)}};this._engine.isWebGPU?(this._voxelGrid=new p("voxelGrid",t,this._scene,{...n,format:5,creationFlags:1}),this._voxelGridRT=new p("voxelGridRT",{width:Math.min(t.width*2,2048),height:Math.min(t.height*2,2048)},this._scene,s)):this._triPlanarVoxelization?(this._voxelGridXaxis=new p("voxelGridXaxis",t,this._scene,s),this._voxelGridYaxis=new p("voxelGridYaxis",t,this._scene,s),this._voxelGridZaxis=new p("voxelGridZaxis",t,this._scene,s),this._voxelMrtsXaxis=this._createVoxelMRTs("x_axis_",this._voxelGridXaxis,i),this._voxelMrtsYaxis=this._createVoxelMRTs("y_axis_",this._voxelGridYaxis,i),this._voxelMrtsZaxis=this._createVoxelMRTs("z_axis_",this._voxelGridZaxis,i),this._combinedVoxelGridPT=new P("combinedVoxelGrid",t,"iblCombineVoxelGrids",this._scene,n,!1),this._scene.proceduralTextures.splice(this._scene.proceduralTextures.indexOf(this._combinedVoxelGridPT),1),this._combinedVoxelGridPT.setFloat("layer",0),this._combinedVoxelGridPT.setTexture("voxelXaxisSampler",this._voxelGridXaxis),this._combinedVoxelGridPT.setTexture("voxelYaxisSampler",this._voxelGridYaxis),this._combinedVoxelGridPT.setTexture("voxelZaxisSampler",this._voxelGridZaxis),this._combinedVoxelGridPT.autoClear=!1,this._combinedVoxelGridPT.wrapU=x.CLAMP_ADDRESSMODE,this._combinedVoxelGridPT.wrapV=x.CLAMP_ADDRESSMODE):(this._voxelGridZaxis=new p("voxelGridZaxis",t,this._scene,n),this._voxelMrtsZaxis=this._createVoxelMRTs("z_axis_",this._voxelGridZaxis,i));const r={generateDepthBuffer:!1,generateMipMaps:!1,type:0,format:6,samplingMode:1,shaderLanguage:e?1:0,extraInitializationsAsync:async()=>{e?await o(()=>import("./iblGenerateVoxelMip.fragment-Du06dfzY.js"),__vite__mapDeps([9,1,2,3]),import.meta.url):await o(()=>import("./iblGenerateVoxelMip.fragment-BiWKxyac.js"),__vite__mapDeps([10,1,2,3]),import.meta.url)}};this._mipArray=new Array(Math.ceil(Math.log2(this._voxelResolution)));for(let a=1;a<=this._mipArray.length;a++){const l=this._voxelResolution>>a,h={width:l,height:l,depth:l};this._mipArray[a-1]=new P("voxelMip"+a,h,"iblGenerateVoxelMip",this._scene,r,!1),this._scene.proceduralTextures.splice(this._scene.proceduralTextures.indexOf(this._mipArray[a-1]),1);const u=this._mipArray[a-1];u.autoClear=!1,u.wrapU=x.CLAMP_ADDRESSMODE,u.wrapV=x.CLAMP_ADDRESSMODE,u.setTexture("srcMip",a>1?this._mipArray[a-2]:this.getVoxelGrid()),u.setInt("layerNum",0)}this._createVoxelMaterials()}_createVoxelMRTs(e,t,s){t.wrapU=x.CLAMP_ADDRESSMODE,t.wrapV=x.CLAMP_ADDRESSMODE,t.noPrePassRenderer=!0;const i=[],n=new Array(this._maxDrawBuffers).fill(32879);for(let r=0;r<s;r++){let a=new Array(this._maxDrawBuffers).fill(0);a=a.map((u,m)=>r*this._maxDrawBuffers+m);let l=new Array(this._maxDrawBuffers).fill("");l=l.map((u,m)=>"voxel_grid_"+e+(r*this._maxDrawBuffers+m));const h=new k("mrt_"+e+r,{width:this._voxelResolution,height:this._voxelResolution,depth:this._voxelResolution},this._maxDrawBuffers,this._scene,{types:new Array(this._maxDrawBuffers).fill(0),samplingModes:new Array(this._maxDrawBuffers).fill(3),generateMipMaps:!1,targetTypes:n,formats:new Array(this._maxDrawBuffers).fill(6),faceIndex:new Array(this._maxDrawBuffers).fill(0),layerIndex:a,layerCounts:new Array(this._maxDrawBuffers).fill(this._voxelResolution),generateDepthBuffer:!1,generateStencilBuffer:!1},l);h.clearColor=new B(0,0,0,1),h.noPrePassRenderer=!0;for(let u=0;u<this._maxDrawBuffers;u++)h.setInternalTexture(t.getInternalTexture(),u);i.push(h)}return i}_disposeVoxelTextures(){this._stopVoxelization();for(let e=0;e<this._voxelMrtsZaxis.length;e++)this._triPlanarVoxelization&&(this._voxelMrtsXaxis[e].dispose(!0),this._voxelMrtsYaxis[e].dispose(!0)),this._voxelMrtsZaxis[e].dispose(!0);this._triPlanarVoxelization&&(this._voxelGridXaxis?.dispose(),this._voxelGridYaxis?.dispose(),this._combinedVoxelGridPT?.dispose()),this._voxelGridZaxis?.dispose();for(const e of this._mipArray)e.dispose();this._voxelMaterial?.dispose(),this._voxelSlabDebugMaterial?.dispose(),this._mipArray=[],this._voxelMrtsXaxis=[],this._voxelMrtsYaxis=[],this._voxelMrtsZaxis=[]}_createVoxelMaterials(){const e=this._engine.isWebGPU;this._voxelMaterial=new A("voxelization",this._scene,"iblVoxelGrid",{uniforms:["world","viewMatrix","invTransWorld","invWorldScale","nearPlane","farPlane","stepSize"],defines:["MAX_DRAW_BUFFERS "+this._maxDrawBuffers],shaderLanguage:e?1:0,extraInitializationsAsync:async()=>{e?await Promise.all([o(()=>import("./iblVoxelGrid.fragment-DSut4gxZ.js"),__vite__mapDeps([11,1,2,3]),import.meta.url),o(()=>import("./iblVoxelGrid.vertex-CD5B4bTZ.js"),__vite__mapDeps([12,1,2,3,13]),import.meta.url)]):await Promise.all([o(()=>import("./iblVoxelGrid.fragment-DqIsPH-b.js"),__vite__mapDeps([14,1,2,3]),import.meta.url),o(()=>import("./iblVoxelGrid.vertex-Bo-k98q7.js"),__vite__mapDeps([15,1,2,3]),import.meta.url)])}}),this._voxelMaterial.cullBackFaces=!1,this._voxelMaterial.backFaceCulling=!1,this._voxelMaterial.depthFunction=D.ALWAYS,this._voxelSlabDebugMaterial=new A("voxelSlabDebug",this._scene,"iblVoxelSlabDebug",{uniforms:["world","viewMatrix","cameraViewMatrix","projection","invWorldScale","nearPlane","farPlane","stepSize"],defines:["MAX_DRAW_BUFFERS "+this._maxDrawBuffers],shaderLanguage:e?1:0,extraInitializationsAsync:async()=>{e?await Promise.all([o(()=>import("./iblVoxelSlabDebug.fragment-CRan6iou.js"),__vite__mapDeps([16,1,2,3]),import.meta.url),o(()=>import("./iblVoxelSlabDebug.vertex-BqPrydof.js"),__vite__mapDeps([17,1,2,3]),import.meta.url)]):await Promise.all([o(()=>import("./iblVoxelSlabDebug.fragment-CzIaoyrK.js"),__vite__mapDeps([18,1,2,3]),import.meta.url),o(()=>import("./iblVoxelSlabDebug.vertex-CbTtGpgR.js"),__vite__mapDeps([19,1,2,3]),import.meta.url)])}})}_setDebugBindings(){this._voxelSlabDebugMaterial.setMatrix("projection",this._scene.activeCamera.getProjectionMatrix()),this._voxelSlabDebugMaterial.setMatrix("cameraViewMatrix",this._scene.activeCamera.getViewMatrix())}isReady(){let e=this.getVoxelGrid().isReady();for(let t=0;t<this._mipArray.length;t++){const s=this._mipArray[t].isReady();e&&(e=s)}return!(!e||this._voxelizationInProgress)}_stopVoxelization(){this._removeVoxelRTs(this._voxelMrtsXaxis),this._removeVoxelRTs(this._voxelMrtsYaxis),this._removeVoxelRTs(this._voxelMrtsZaxis),this._removeVoxelRTs([this._voxelGridRT])}_removeVoxelRTs(e){const t=this._renderTargets.findIndex(s=>s===e[0]);if(t>=0)this._renderTargets.splice(t,e.length);else{const s=this._scene.customRenderTargets.findIndex(i=>i===e[0]);s>=0&&this._scene.customRenderTargets.splice(s,e.length)}}updateVoxelGrid(e){this._stopVoxelization(),this._includedMeshes=e,this._voxelizationInProgress=!0,this._engine.isWebGPU?(this._voxelGridRT.renderList=e,this._addRTsForRender([this._voxelGridRT],e,0)):this._triPlanarVoxelization?(this._addRTsForRender(this._voxelMrtsXaxis,e,0),this._addRTsForRender(this._voxelMrtsYaxis,e,1),this._addRTsForRender(this._voxelMrtsZaxis,e,2)):this._addRTsForRender(this._voxelMrtsZaxis,e,2),this._voxelDebugEnabled&&this._addRTsForRender([this._voxelSlabDebugRT],e,this._voxelDebugAxis,1,!0),this._renderVoxelGridBound=this._renderVoxelGrid.bind(this),this._scene.onAfterRenderObservable.add(this._renderVoxelGridBound)}_renderVoxelGrid(){if(this._voxelizationInProgress){let e=this.getVoxelGrid().isReady();for(let t=0;t<this._mipArray.length;t++){const s=this._mipArray[t].isReady();e&&(e=s)}for(let t=0;t<this._renderTargets.length;t++){const s=this._renderTargets[t].isReadyForRendering();e&&(e=s)}if(e){if(this._engine.isWebGPU&&this._voxelGrid&&this._voxelGrid.renderTarget)for(let t=0;t<this._voxelResolution;t++)this._engine.bindFramebuffer(this._voxelGrid.renderTarget,0,void 0,void 0,!0,0,t),this._engine.clear(this._voxelClearColor,!0,!1,!1),this._engine.unBindFramebuffer(this._voxelGrid.renderTarget,!0);for(const t of this._renderTargets)t.render();this._stopVoxelization(),this._triPlanarVoxelization&&!this._engine.isWebGPU&&this._combinedVoxelGridPT.render(),this._generateMipMaps(),this._copyMipEffectWrapper.effect.whenCompiledAsync().then(()=>{this._copyMipMaps(),this._scene.onAfterRenderObservable.removeCallback(this._renderVoxelGridBound),this._voxelizationInProgress=!1,this.onVoxelizationCompleteObservable.notifyObservers()})}}}_addRTsForRender(e,t,s,i=0,n=!1){const r=1/this._computeNumberOfSlabs();let a;i===0?a=this._voxelMaterial:a=this._voxelSlabDebugMaterial;for(let l=0;l<e.length;l++){const h=e[l];h.renderList=[];const u=l*r,m=(l+1)*r,G=r/this._maxDrawBuffers,z=new g(0,0,0);let E=new g(0,0,1);s===0?E=new g(1,0,0):s===1&&(E=new g(0,1,0));let O=new g(0,1,0);if(s===1&&(O=new g(1,0,0)),h.onBeforeRenderObservable.add(()=>{a.setMatrix("viewMatrix",b.LookAtLH(z,E,O)),a.setMatrix("invWorldScale",this._invWorldScaleMatrix),a.setFloat("nearPlane",u),a.setFloat("farPlane",m),a.setFloat("stepSize",G),this._engine.isWebGPU&&(this._voxelMaterial.useVertexPulling=!0,this._voxelMaterial.setTexture("voxel_storage",this.getVoxelGrid()))}),t.length===0)return;for(const v of t)if(v){v.subMeshes&&v.subMeshes.length>0&&(h.renderList?.push(v),h.setMaterialForRendering(v,a));const W=v.getChildMeshes();for(const S of W)S.subMeshes&&S.subMeshes.length>0&&(h.renderList?.push(S),h.setMaterialForRendering(S,a))}}if(n)for(const l of e)this._scene.customRenderTargets.indexOf(l)===-1&&this._scene.customRenderTargets.push(l);else this._renderTargets=this._renderTargets.concat(e)}resize(){this._voxelSlabDebugRT?.resize({width:this._scene.getEngine().getRenderWidth(),height:this._scene.getEngine().getRenderHeight()})}dispose(){this._disposeVoxelTextures(),this._voxelSlabDebugRT&&(this._removeVoxelRTs([this._voxelSlabDebugRT]),this._voxelSlabDebugRT.dispose()),this._voxelDebugPass&&this._voxelDebugPass.dispose()}}class J{get voxelShadowOpacity(){return this._voxelShadowOpacity}set voxelShadowOpacity(e){this._voxelShadowOpacity=e}get ssShadowOpacity(){return this._ssShadowOpacity}set ssShadowOpacity(e){this._ssShadowOpacity=e}get sssSamples(){return this._sssSamples}set sssSamples(e){this._sssSamples=e}get sssStride(){return this._sssStride}set sssStride(e){this._sssStride=e}get sssMaxDist(){return this._sssMaxDist}set sssMaxDist(e){this._sssMaxDist=e}get sssThickness(){return this._sssThickness}set sssThickness(e){this._sssThickness=e}get voxelNormalBias(){return this._voxelNormalBias}set voxelNormalBias(e){this._voxelNormalBias=e}get voxelDirectionBias(){return this._voxelDirectionBias}set voxelDirectionBias(e){this._voxelDirectionBias=e}get sampleDirections(){return this._sampleDirections}set sampleDirections(e){this._sampleDirections=e}get envRotation(){return this._envRotation}set envRotation(e){this._envRotation=e}getOutputTexture(){return this._outputTexture}getDebugPassPP(){return this._debugPassPP||this._createDebugPass(),this._debugPassPP}get debugPassName(){return this._debugPassName}setWorldScaleMatrix(e){this._invWorldScaleMatrix=e}set coloredShadows(e){this._coloredShadows=e}get coloredShadows(){return this._coloredShadows}setDebugDisplayParams(e,t,s,i){this._debugSizeParams.set(e,t,s,i)}_createDebugPass(){const e=this._engine.isWebGPU;if(!this._debugPassPP){const t={width:this._engine.getRenderWidth(),height:this._engine.getRenderHeight(),uniforms:["sizeParams"],samplers:["debugSampler"],engine:this._engine,reusable:!0,shaderLanguage:e?1:0,extraInitializations:(s,i)=>{s?i.push(o(()=>import("./iblShadowDebug.fragment-CZC809qZ.js"),__vite__mapDeps([20,1,2,3]),import.meta.url)):i.push(o(()=>import("./iblShadowDebug.fragment-CjxLqNHB.js"),__vite__mapDeps([21,1,2,3]),import.meta.url))}};this._debugPassPP=new w(this.debugPassName,"iblShadowDebug",t),this._debugPassPP.autoClear=!1,this._debugPassPP.onApplyObservable.add(s=>{s.setTexture("debugSampler",this._outputTexture),s.setVector4("sizeParams",this._debugSizeParams)})}}constructor(e,t){this._voxelShadowOpacity=1,this._sssSamples=16,this._sssStride=8,this._sssMaxDist=.05,this._sssThickness=.5,this._ssShadowOpacity=1,this._cameraInvView=b.Identity(),this._cameraInvProj=b.Identity(),this._invWorldScaleMatrix=b.Identity(),this._frameId=0,this._sampleDirections=4,this._shadowParameters=new f(0,0,0,0),this._sssParameters=new f(0,0,0,0),this._opacityParameters=new f(0,0,0,0),this._voxelBiasParameters=new f(0,0,0,0),this._voxelNormalBias=1.4,this._voxelDirectionBias=1.75,this.enabled=!0,this.debugEnabled=!1,this._debugPassName="Voxel Tracing Debug Pass",this._envRotation=0,this._coloredShadows=!1,this._debugVoxelMarchEnabled=!1,this._debugSizeParams=new f(0,0,0,0),this._renderWhenGBufferReady=null,this._scene=e,this._engine=e.getEngine(),this._renderPipeline=t,this._createTextures()}_createTextures(){const e=this._createDefines(),t=this._engine.isWebGPU,s={type:0,format:5,samplingMode:1,generateDepthBuffer:!1,shaderLanguage:t?1:0,extraInitializationsAsync:async()=>{t?await Promise.all([o(()=>import("./iblShadowVoxelTracing.fragment-4S9qIv4P.js"),__vite__mapDeps([22,1,2,3]),import.meta.url)]):await Promise.all([o(()=>import("./iblShadowVoxelTracing.fragment-C_9FoJ7d.js"),__vite__mapDeps([23,1,2,3]),import.meta.url)])}};this._outputTexture=new P("voxelTracingPass",{width:this._engine.getRenderWidth(),height:this._engine.getRenderHeight()},"iblShadowVoxelTracing",this._scene,s),this._outputTexture.refreshRate=-1,this._outputTexture.autoClear=!1,this._outputTexture.defines=e,this._setBindings(this._scene.activeCamera),this._renderWhenGBufferReady=this._render.bind(this),this._renderPipeline.onVoxelizationCompleteObservable.addOnce(()=>{this._scene.geometryBufferRenderer.getGBuffer().onAfterRenderObservable.add(this._renderWhenGBufferReady)})}_createDefines(){let e="";return this._scene.useRightHandedSystem&&(e+=`#define RIGHT_HANDED
`),this._debugVoxelMarchEnabled&&(e+=`#define VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION 1u
`),this._coloredShadows&&(e+=`#define COLOR_SHADOWS 1u
`),e}_setBindings(e){this._outputTexture.defines=this._createDefines(),this._outputTexture.setMatrix("viewMtx",e.getViewMatrix()),this._outputTexture.setMatrix("projMtx",e.getProjectionMatrix()),e.getProjectionMatrix().invertToRef(this._cameraInvProj),e.getViewMatrix().invertToRef(this._cameraInvView),this._outputTexture.setMatrix("invProjMtx",this._cameraInvProj),this._outputTexture.setMatrix("invViewMtx",this._cameraInvView),this._outputTexture.setMatrix("wsNormalizationMtx",this._invWorldScaleMatrix),this._frameId++;let t=0;this._scene.environmentTexture&&(t=this._scene.environmentTexture.rotationY??0),t=this._scene.useRightHandedSystem?-(t+.5*Math.PI):t-.5*Math.PI,t=t%(2*Math.PI),this._shadowParameters.set(this._sampleDirections,this._frameId,1,t),this._outputTexture.setVector4("shadowParameters",this._shadowParameters);const s=this._renderPipeline._getVoxelGridTexture(),i=Math.floor(Math.log2(s.getSize().width));this._voxelBiasParameters.set(this._voxelNormalBias,this._voxelDirectionBias,i,0),this._outputTexture.setVector4("voxelBiasParameters",this._voxelBiasParameters),this._sssParameters.set(this._sssSamples,this._sssStride,this._sssMaxDist,this._sssThickness),this._outputTexture.setVector4("sssParameters",this._sssParameters),this._opacityParameters.set(this._voxelShadowOpacity,this._ssShadowOpacity,0,0),this._outputTexture.setVector4("shadowOpacity",this._opacityParameters),this._outputTexture.setTexture("voxelGridSampler",s),this._outputTexture.setTexture("blueNoiseSampler",this._renderPipeline._getNoiseTexture());const n=this._scene.iblCdfGenerator;if(!n)return _.Warn("IBLShadowsVoxelTracingPass: Can't bind for render because iblCdfGenerator is not enabled."),!1;this._outputTexture.setTexture("icdfSampler",n.getIcdfTexture()),this._coloredShadows&&this._scene.environmentTexture&&this._outputTexture.setTexture("iblSampler",this._scene.environmentTexture);const r=this._scene.geometryBufferRenderer;if(!r)return _.Warn("IBLShadowsVoxelTracingPass: Can't bind for render because GeometryBufferRenderer is not enabled."),!1;const a=r.getTextureIndex(d.SCREENSPACE_DEPTH_TEXTURE_TYPE);this._outputTexture.setTexture("depthSampler",r.getGBuffer().textures[a]);const l=r.getTextureIndex(d.NORMAL_TEXTURE_TYPE);return this._outputTexture.setTexture("worldNormalSampler",r.getGBuffer().textures[l]),!0}_render(){this.enabled&&this._outputTexture.isReady()&&this._outputTexture.getEffect()?.isReady()&&this._setBindings(this._scene.activeCamera)&&this._outputTexture.render()}resize(e=1){const t={width:Math.max(1,Math.floor(this._engine.getRenderWidth()*e)),height:Math.max(1,Math.floor(this._engine.getRenderHeight()*e))};this._outputTexture.getSize().width===t.width&&this._outputTexture.getSize().height===t.height||this._outputTexture.resize(t,!1)}isReady(){return this._outputTexture.isReady()&&!(this._debugPassPP&&!this._debugPassPP.isReady())&&this._scene.iblCdfGenerator&&this._scene.iblCdfGenerator.getIcdfTexture().isReady()&&this._renderPipeline._getVoxelGridTexture().isReady()}dispose(){this._scene.geometryBufferRenderer&&this._renderWhenGBufferReady&&this._scene.geometryBufferRenderer.getGBuffer().onAfterRenderObservable.removeCallback(this._renderWhenGBufferReady),this._outputTexture.dispose(),this._debugPassPP&&this._debugPassPP.dispose()}}class ${getOutputTexture(){return this._outputTexture}getDebugPassPP(){return this._debugPassPP||this._createDebugPass(),this._debugPassPP}get debugPassName(){return this._debugPassName}setWorldScale(e){this._worldScale=e}setDebugDisplayParams(e,t,s,i){this._debugSizeParams.set(e,t,s,i)}_createDebugPass(){if(!this._debugPassPP){const e=this._engine.isWebGPU,t={width:this._engine.getRenderWidth(),height:this._engine.getRenderHeight(),textureFormat:5,textureType:0,samplingMode:1,uniforms:["sizeParams"],samplers:["debugSampler"],engine:this._engine,reusable:!1,shaderLanguage:e?1:0,extraInitializations:(s,i)=>{s?i.push(o(()=>import("./iblShadowDebug.fragment-CZC809qZ.js"),__vite__mapDeps([20,1,2,3]),import.meta.url)):i.push(o(()=>import("./iblShadowDebug.fragment-CjxLqNHB.js"),__vite__mapDeps([21,1,2,3]),import.meta.url))}};this._debugPassPP=new w(this.debugPassName,"iblShadowDebug",t),this._debugPassPP.autoClear=!1,this._debugPassPP.onApplyObservable.add(s=>{s.setTexture("debugSampler",this._outputTexture),s.setVector4("sizeParams",this._debugSizeParams)})}}constructor(e,t){this._worldScale=1,this._blurParameters=new f(0,0,0,0),this.enabled=!0,this._debugPassName="Spatial Blur Debug Pass",this.debugEnabled=!1,this._debugSizeParams=new f(0,0,0,0),this._renderWhenGBufferReady=null,this._scene=e,this._engine=e.getEngine(),this._renderPipeline=t,this._createTextures()}_createTextures(){const e=this._engine.isWebGPU,t={type:0,format:5,samplingMode:1,generateDepthBuffer:!1,generateMipMaps:!1,shaderLanguage:e?1:0,extraInitializationsAsync:async()=>{e?await Promise.all([o(()=>import("./iblShadowSpatialBlur.fragment-oFXyvYXL.js"),__vite__mapDeps([24,1,2,3]),import.meta.url)]):await Promise.all([o(()=>import("./iblShadowSpatialBlur.fragment-DI3lbwxW.js"),__vite__mapDeps([25,1,2,3]),import.meta.url)])}};this._outputTexture=new P("spatialBlurPass",{width:this._engine.getRenderWidth(),height:this._engine.getRenderHeight()},"iblShadowSpatialBlur",this._scene,t,!1,!1,0),this._outputTexture.refreshRate=-1,this._outputTexture.autoClear=!1,this._setBindings(),this._renderWhenGBufferReady=this._render.bind(this),this._renderPipeline.onVoxelizationCompleteObservable.addOnce(()=>{this._scene.geometryBufferRenderer.getGBuffer().onAfterRenderObservable.add(this._renderWhenGBufferReady)})}_setBindings(){this._outputTexture.setTexture("voxelTracingSampler",this._renderPipeline._getVoxelTracingTexture()),this._blurParameters.set(1,this._worldScale,0,0),this._outputTexture.setVector4("blurParameters",this._blurParameters);const t=this._scene.geometryBufferRenderer;if(!t)return!1;const s=t.getTextureIndex(d.SCREENSPACE_DEPTH_TEXTURE_TYPE);this._outputTexture.setTexture("depthSampler",t.getGBuffer().textures[s]);const i=t.getTextureIndex(d.NORMAL_TEXTURE_TYPE);return this._outputTexture.setTexture("worldNormalSampler",t.getGBuffer().textures[i]),!0}_render(){this.enabled&&this._outputTexture.isReady()&&this._outputTexture.getEffect()?.isReady()&&this._setBindings()&&this._outputTexture.render()}resize(e=1){const t={width:Math.max(1,Math.floor(this._engine.getRenderWidth()*e)),height:Math.max(1,Math.floor(this._engine.getRenderHeight()*e))};this._outputTexture.getSize().width===t.width&&this._outputTexture.getSize().height===t.height||this._outputTexture.resize(t,!1)}isReady(){return this._outputTexture.isReady()&&!(this._debugPassPP&&!this._debugPassPP.isReady())}dispose(){this._scene.geometryBufferRenderer&&this._renderWhenGBufferReady&&this._scene.geometryBufferRenderer.getGBuffer().onAfterRenderObservable.removeCallback(this._renderWhenGBufferReady),this._outputTexture.dispose(),this._debugPassPP&&this._debugPassPP.dispose()}}class ee{getOutputTexture(){return this._outputTexture}getDebugPassPP(){return this._debugPassPP||this._createDebugPass(),this._debugPassPP}get debugPassName(){return this._debugPassName}get remanence(){return this._remanence}set remanence(e){this._remanence=e}get reset(){return this._reset}set reset(e){this._reset=e}set isMoving(e){this._isMoving=e}setDebugDisplayParams(e,t,s,i){this._debugSizeParams.set(e,t,s,i)}_createDebugPass(){if(!this._debugPassPP){const e=this._engine.isWebGPU,t={width:this._engine.getRenderWidth(),height:this._engine.getRenderHeight(),textureFormat:5,textureType:0,samplingMode:1,uniforms:["sizeParams"],samplers:["debugSampler"],engine:this._engine,reusable:!1,shaderLanguage:e?1:0,extraInitializations:(s,i)=>{s?i.push(o(()=>import("./iblShadowDebug.fragment-CZC809qZ.js"),__vite__mapDeps([20,1,2,3]),import.meta.url)):i.push(o(()=>import("./iblShadowDebug.fragment-CjxLqNHB.js"),__vite__mapDeps([21,1,2,3]),import.meta.url))}};this._debugPassPP=new w(this.debugPassName,"iblShadowDebug",t),this._debugPassPP.autoClear=!1,this._debugPassPP.onApplyObservable.add(s=>{s.setTexture("debugSampler",this._outputTexture),s.setVector4("sizeParams",this._debugSizeParams)})}}constructor(e,t){this._accumulationParams=new f(0,0,0,0),this.debugEnabled=!1,this.enabled=!0,this.onReadyObservable=new R,this._debugPassName="Shadow Accumulation Debug Pass",this._remanence=.9,this._reset=!0,this._isMoving=!1,this._debugSizeParams=new f(0,0,0,0),this._renderWhenGBufferReady=null,this._scene=e,this._engine=e.getEngine(),this._renderPipeline=t,this._createTextures()}_createTextures(){const e=this._engine.isWebGPU,t={type:2,format:5,samplingMode:1,generateDepthBuffer:!1,generateMipMaps:!1,shaderLanguage:e?1:0,extraInitializationsAsync:async()=>{e?await Promise.all([o(()=>import("./iblShadowAccumulation.fragment-D8HyPjwE.js"),__vite__mapDeps([26,1,2,3]),import.meta.url)]):await Promise.all([o(()=>import("./iblShadowAccumulation.fragment-CTwX4MIS.js"),__vite__mapDeps([27,1,2,3]),import.meta.url)])}};this._outputTexture=new P("shadowAccumulationPass",{width:this._engine.getRenderWidth(),height:this._engine.getRenderHeight()},"iblShadowAccumulation",this._scene,t),this._outputTexture.refreshRate=1,this._outputTexture.autoClear=!1,this._outputTexture.onGeneratedObservable.addOnce(()=>{this.onReadyObservable.notifyObservers()}),this._setOutputTextureBindings(),this._renderWhenGBufferReady=this._render.bind(this),this._renderPipeline.onVoxelizationCompleteObservable.addOnce(()=>{this._scene.geometryBufferRenderer.getGBuffer().onAfterRenderObservable.add(this._renderWhenGBufferReady)});const s={type:2,format:5,samplingMode:1,generateDepthBuffer:!1,generateMipMaps:!1,shaderLanguage:e?1:0,extraInitializationsAsync:async()=>{e?await Promise.all([o(()=>import("./pass.fragment-CYzqJzMR.js"),__vite__mapDeps([28,1,2,3]),import.meta.url)]):await Promise.all([o(()=>import("./pass.fragment-B0nXoPvp.js"),__vite__mapDeps([29,1,2,3]),import.meta.url)])}};this._oldAccumulationCopy=new P("oldAccumulationRT",{width:this._engine.getRenderWidth(),height:this._engine.getRenderHeight()},"pass",this._scene,s,!1),this._oldAccumulationCopy.autoClear=!1,this._oldAccumulationCopy.refreshRate=1,this._oldAccumulationCopy.onBeforeGenerationObservable.add(this._setAccumulationCopyBindings.bind(this)),this._setAccumulationCopyBindings();const i={type:2,format:5,samplingMode:1,generateDepthBuffer:!1,generateMipMaps:!1,shaderLanguage:e?1:0,extraInitializationsAsync:async()=>{e?await Promise.all([o(()=>import("./pass.fragment-CYzqJzMR.js"),__vite__mapDeps([28,1,2,3]),import.meta.url)]):await Promise.all([o(()=>import("./pass.fragment-B0nXoPvp.js"),__vite__mapDeps([29,1,2,3]),import.meta.url)])}};this._oldPositionCopy=new P("oldLocalPositionRT",{width:this._engine.getRenderWidth(),height:this._engine.getRenderHeight()},"pass",this._scene,i,!1),this._updatePositionCopy(),this._oldPositionCopy.autoClear=!1,this._oldPositionCopy.refreshRate=1,this._oldPositionCopy.onBeforeGenerationObservable.add(this._updatePositionCopy.bind(this))}_setOutputTextureBindings(){const e=this._isMoving?this.remanence:.99;this._accumulationParams.set(e,this.reset?1:0,this._renderPipeline.voxelGridSize,0),this._outputTexture.setTexture("spatialBlurSampler",this._renderPipeline._getSpatialBlurTexture()),this._outputTexture.setVector4("accumulationParameters",this._accumulationParams),this._outputTexture.setTexture("oldAccumulationSampler",this._oldAccumulationCopy?this._oldAccumulationCopy:this._renderPipeline._dummyTexture2d),this._outputTexture.setTexture("prevPositionSampler",this._oldPositionCopy?this._oldPositionCopy:this._renderPipeline._dummyTexture2d);const t=this._scene.geometryBufferRenderer;if(!t)return!1;const s=t.getTextureIndex(d.VELOCITY_LINEAR_TEXTURE_TYPE);this._outputTexture.setTexture("motionSampler",t.getGBuffer().textures[s]);const i=t.getTextureIndex(d.POSITION_TEXTURE_TYPE);return this._outputTexture.setTexture("positionSampler",t.getGBuffer().textures[i]),this.reset=!1,this._isMoving=!1,!0}_updatePositionCopy(){const e=this._scene.geometryBufferRenderer,t=e.getTextureIndex(d.POSITION_TEXTURE_TYPE);this._oldPositionCopy.setTexture("textureSampler",e.getGBuffer().textures[t])}_setAccumulationCopyBindings(){this._oldAccumulationCopy.setTexture("textureSampler",this._outputTexture)}_render(){this.enabled&&this._outputTexture.isReady()&&this._outputTexture.getEffect()?.isReady()&&this._setOutputTextureBindings()&&this._outputTexture.render()}resize(e=1){const t={width:Math.max(1,Math.floor(this._engine.getRenderWidth()*e)),height:Math.max(1,Math.floor(this._engine.getRenderHeight()*e))};this._outputTexture.getSize().width===t.width&&this._outputTexture.getSize().height===t.height||(this._outputTexture.resize(t,!1),this._oldAccumulationCopy.resize(t,!1),this._oldPositionCopy.resize({width:this._engine.getRenderWidth(),height:this._engine.getRenderHeight()},!1),this.reset=!0)}_disposeTextures(){this._oldAccumulationCopy.dispose(),this._oldPositionCopy.dispose(),this._outputTexture.dispose()}isReady(){return this._oldAccumulationCopy&&this._oldAccumulationCopy.isReady()&&this._oldPositionCopy&&this._oldPositionCopy.isReady()&&this._outputTexture.isReady()&&!(this._debugPassPP&&!this._debugPassPP.isReady())}dispose(){this._scene.geometryBufferRenderer&&this._renderWhenGBufferReady&&this._scene.geometryBufferRenderer.getGBuffer().onAfterRenderObservable.removeCallback(this._renderWhenGBufferReady),this._disposeTextures(),this._debugPassPP&&this._debugPassPP.dispose(),this.onReadyObservable.clear()}}class te extends x{get width(){return this._texture?this._texture.width:0}get height(){return this._texture?this._texture.height:0}get depth(){return this._texture?this._texture.depth:0}constructor(e,t,s,i,n,r,a=!0,l=!1,h=x.TRILINEAR_SAMPLINGMODE,u=0,m){super(null,r,!a,l),this.format=n,this._texture=r.getEngine().createRawTexture3D(e,t,s,i,n,a,l,h,null,u,m),this.is3D=!0}update(e){this._texture&&this._getEngine().updateRawTexture3D(this._texture,e,this._texture.format,this._texture.invertY,null,this._texture.type)}}class se extends U{constructor(){super(...arguments),this.RENDER_WITH_IBL_SHADOWS=!1,this.COLORED_IBL_SHADOWS=!1}}class c extends F{get isColored(){return this._isColored}set isColored(e){this._isColored!==e&&(this._isColored=e,this._markAllSubMeshesAsTexturesDirty())}_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}isCompatible(){return!0}constructor(e){super(e,c.Name,310,new se),this.shadowOpacity=1,this._isEnabled=!1,this._isColored=!1,this.isEnabled=!1,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1]}prepareDefines(e){e.RENDER_WITH_IBL_SHADOWS=this._isEnabled,e.COLORED_IBL_SHADOWS=this.isColored}getClassName(){return"IBLShadowsPluginMaterial"}getUniforms(){return{ubo:[{name:"renderTargetSize",size:2,type:"vec2"},{name:"shadowOpacity",size:1,type:"float"}],fragment:`#ifdef RENDER_WITH_IBL_SHADOWS
                    uniform vec2 renderTargetSize;
                    uniform float shadowOpacity;
                #endif`}}getSamplers(e){e.push("iblShadowsTexture")}bindForSubMesh(e){this._isEnabled&&(e.bindTexture("iblShadowsTexture",this.iblShadowsTexture),e.updateFloat2("renderTargetSize",this._material.getScene().getEngine().getRenderWidth(),this._material.getScene().getEngine().getRenderHeight()),e.updateFloat("shadowOpacity",this.shadowOpacity))}getCustomCode(e,t){let s;return t===1?(s={CUSTOM_FRAGMENT_DEFINITIONS:`
                #ifdef RENDER_WITH_IBL_SHADOWS
                    var iblShadowsTextureSampler: sampler;
                    var iblShadowsTexture: texture_2d<f32>;

                    #ifdef COLORED_IBL_SHADOWS
                        fn computeIndirectShadow() -> vec3f {
                            var uv = fragmentInputs.position.xy / uniforms.renderTargetSize;
                            var shadowValue: vec3f = textureSample(iblShadowsTexture, iblShadowsTextureSampler, uv).rgb;
                            return mix(shadowValue, vec3f(1.0), 1.0 - uniforms.shadowOpacity);
                        }
                    #else
                        fn computeIndirectShadow() -> vec2f {
                            var uv = fragmentInputs.position.xy / uniforms.renderTargetSize;
                            var shadowValue: vec2f = textureSample(iblShadowsTexture, iblShadowsTextureSampler, uv).rg;
                            return mix(shadowValue, vec2f(1.0), 1.0 - uniforms.shadowOpacity);
                        }
                    #endif
                #endif
            `},this._material instanceof y?s.CUSTOM_FRAGMENT_BEFORE_FINALCOLORCOMPOSITION=`
                #ifdef RENDER_WITH_IBL_SHADOWS
                    #ifndef UNLIT
                        #ifdef REFLECTION
                            #ifdef COLORED_IBL_SHADOWS
                                var shadowValue: vec3f = computeIndirectShadow();
                                finalIrradiance *= shadowValue;
                                finalRadianceScaled *= mix(vec3f(1.0), shadowValue, roughness);
                            #else
                                var shadowValue: vec2f = computeIndirectShadow();
                                finalIrradiance *= vec3f(shadowValue.x);
                                finalRadianceScaled *= vec3f(mix(pow(shadowValue.y, 4.0), shadowValue.x, roughness));
                            #endif
                        #endif
                    #else
                        finalDiffuse *= computeIndirectShadow().x;
                    #endif
                #endif
            `:this._material instanceof M?s.CUSTOM_FRAGMENT_BEFORE_IBLLAYERCOMPOSITION=`
                #ifdef RENDER_WITH_IBL_SHADOWS
                    #ifndef UNLIT
                        #ifdef REFLECTION
                            #ifdef COLORED_IBL_SHADOWS
                                var shadowValue: vec3f = computeIndirectShadow();
                                slab_diffuse_ibl *= shadowValue;
                                slab_glossy_ibl *= mix(vec3f(1.0), shadowValue, specularAlphaG);
                            #else
                                var shadowValue: vec2f = computeIndirectShadow();
                                slab_diffuse_ibl *= vec3f(shadowValue.x);
                                slab_glossy_ibl *= vec3f(mix(pow(shadowValue.y, 4.0), shadowValue.x, specularAlphaG));
                            #endif
                        #endif
                    #else
                        slab_diffuse_ibl *= computeIndirectShadow().x;
                    #endif
                #endif
            `:s.CUSTOM_FRAGMENT_BEFORE_FRAGCOLOR=`
                #ifdef RENDER_WITH_IBL_SHADOWS
                    #ifdef COLORED_IBL_SHADOWS
                        var shadowValue: vec3f = computeIndirectShadow();
                        color *= toGammaSpace(vec4f(shadowValue, 1.0f));
                    #else
                        var shadowValue: vec2f = computeIndirectShadow();
                        color *= toGammaSpace(vec4f(shadowValue.x, shadowValue.x, shadowValue.x, 1.0f));
                    #endif
                #endif
            `):(s={CUSTOM_FRAGMENT_DEFINITIONS:`
                #ifdef RENDER_WITH_IBL_SHADOWS
                    uniform sampler2D iblShadowsTexture;
                #ifdef COLORED_IBL_SHADOWS
                    vec3 computeIndirectShadow() {
                        vec2 uv = gl_FragCoord.xy / renderTargetSize;
                        vec3 shadowValue = texture2D(iblShadowsTexture, uv).rgb;
                        return mix(shadowValue.rgb, vec3(1.0), 1.0 - shadowOpacity);
                    }
                #else
                    vec2 computeIndirectShadow() {
                        vec2 uv = gl_FragCoord.xy / renderTargetSize;
                        vec2 shadowValue = texture2D(iblShadowsTexture, uv).rg;
                        return mix(shadowValue.rg, vec2(1.0), 1.0 - shadowOpacity);
                    }
                #endif
                #endif
            `},this._material instanceof y?s.CUSTOM_FRAGMENT_BEFORE_FINALCOLORCOMPOSITION=`
                #ifdef RENDER_WITH_IBL_SHADOWS
                    #ifndef UNLIT
                        #ifdef REFLECTION
                            #ifdef COLORED_IBL_SHADOWS
                                vec3 shadowValue = computeIndirectShadow();
                                finalIrradiance.rgb *= shadowValue.rgb;
                                finalRadianceScaled *= mix(vec3(1.0), shadowValue.rgb, roughness);
                            #else
                                vec2 shadowValue = computeIndirectShadow();
                                finalIrradiance *= shadowValue.x;
                                finalRadianceScaled *= mix(pow(shadowValue.y, 4.0), shadowValue.x, roughness);
                            #endif
                        #endif
                    #else
                        finalDiffuse *= computeIndirectShadow().x;
                    #endif
                #endif
            `:this._material instanceof M?s.CUSTOM_FRAGMENT_BEFORE_IBLLAYERCOMPOSITION=`
                #ifdef RENDER_WITH_IBL_SHADOWS
                    #ifndef UNLIT
                        #ifdef REFLECTION
                            #ifdef COLORED_IBL_SHADOWS
                                vec3 shadowValue = computeIndirectShadow();
                                slab_diffuse_ibl.rgb *= shadowValue.rgb;
                                slab_glossy_ibl *= mix(vec3(1.0), shadowValue.rgb, specularAlphaG);
                            #else
                                vec2 shadowValue = computeIndirectShadow();
                                slab_diffuse_ibl *= shadowValue.x;
                                slab_glossy_ibl *= mix(pow(shadowValue.y, 4.0), shadowValue.x, specularAlphaG);
                            #endif
                        #endif
                    #else
                        slab_diffuse_ibl *= computeIndirectShadow().x;
                    #endif
                #endif
            `:s.CUSTOM_FRAGMENT_BEFORE_FRAGCOLOR=`
                #ifdef RENDER_WITH_IBL_SHADOWS
                    #ifdef COLORED_IBL_SHADOWS
                        vec3 shadowValue = computeIndirectShadow();
                        color.rgb *= toGammaSpace(shadowValue.rgb);
                    #else
                        vec2 shadowValue = computeIndirectShadow();
                        color.rgb *= toGammaSpace(shadowValue.x);
                    #endif
                #endif
            `),e==="vertex"?null:s}}c.Name="IBLShadowsPluginMaterial";V([C()],c.prototype,"shadowOpacity",void 0);V([C(),H("_markAllSubMeshesAsTexturesDirty")],c.prototype,"isEnabled",void 0);X("BABYLON.IBLShadowsPluginMaterial",c);class Ge extends Z{resetAccumulation(){this._accumulationPass.reset=!0}get shadowOpacity(){return this._shadowOpacity}set shadowOpacity(e){this._shadowOpacity=e,this._setPluginParameters()}get coloredShadows(){return this._coloredShadows}set coloredShadows(e){this._coloredShadows=e,this._voxelTracingPass.coloredShadows=e,this._setPluginParameters()}get shadowRenderSizeFactor(){return this._renderSizeFactor}set shadowRenderSizeFactor(e){this._renderSizeFactor=Math.max(Math.min(e,1),0),this._voxelTracingPass.resize(e),this._spatialBlurPass.resize(e),this._accumulationPass.resize(e),this._setPluginParameters()}get voxelShadowOpacity(){return this._voxelTracingPass?.voxelShadowOpacity}set voxelShadowOpacity(e){this._voxelTracingPass&&(this._voxelTracingPass.voxelShadowOpacity=e)}get ssShadowOpacity(){return this._voxelTracingPass?.ssShadowOpacity}set ssShadowOpacity(e){this._voxelTracingPass&&(this._voxelTracingPass.ssShadowOpacity=e)}get ssShadowSampleCount(){return this._voxelTracingPass?.sssSamples}set ssShadowSampleCount(e){this._voxelTracingPass&&(this._voxelTracingPass.sssSamples=e)}get ssShadowStride(){return this._voxelTracingPass?.sssStride}set ssShadowStride(e){this._voxelTracingPass&&(this._voxelTracingPass.sssStride=e)}get ssShadowDistanceScale(){return this._sssMaxDistScale}set ssShadowDistanceScale(e){this._sssMaxDistScale=e,this._updateSsShadowParams()}get ssShadowThicknessScale(){return this._sssThicknessScale}set ssShadowThicknessScale(e){this._sssThicknessScale=e,this._updateSsShadowParams()}_getVoxelGridTexture(){const e=this._voxelRenderer?.getVoxelGrid();return e&&e.isReady()?e:this._dummyTexture3d}_getNoiseTexture(){const e=this._noiseTexture;return e&&e.isReady()?e:this._dummyTexture2d}_getVoxelTracingTexture(){const e=this._voxelTracingPass?.getOutputTexture();return e&&e.isReady()?e:this._dummyTexture2d}_getSpatialBlurTexture(){const e=this._spatialBlurPass.getOutputTexture();return e&&e.isReady()?e:this._dummyTexture2d}_getAccumulatedTexture(){const e=this._accumulationPass?.getOutputTexture();return e&&e.isReady()?e:this._dummyTexture2d}get gbufferDebugEnabled(){return this._gbufferDebugEnabled}set gbufferDebugEnabled(e){if(e&&!this.allowDebugPasses){_.Warn("Can't enable G-Buffer debug view without setting allowDebugPasses to true.");return}this._gbufferDebugEnabled=e,e?this._enableEffect(this._getGBufferDebugPass().name,this.cameras):this._disableEffect(this._getGBufferDebugPass().name,this.cameras)}get cdfDebugEnabled(){return this.scene.iblCdfGenerator?this.scene.iblCdfGenerator.debugEnabled:!1}set cdfDebugEnabled(e){if(this.scene.iblCdfGenerator){if(e&&!this.allowDebugPasses){_.Warn("Can't enable importance sampling debug view without setting allowDebugPasses to true.");return}e!==this.scene.iblCdfGenerator.debugEnabled&&(this.scene.iblCdfGenerator.debugEnabled=e,e?this._enableEffect(this.scene.iblCdfGenerator.debugPassName,this.cameras):this._disableEffect(this.scene.iblCdfGenerator.debugPassName,this.cameras))}}get voxelDebugEnabled(){return this._voxelRenderer?.voxelDebugEnabled}set voxelDebugEnabled(e){if(this._voxelRenderer){if(e&&!this.allowDebugPasses){_.Warn("Can't enable voxel debug view without setting allowDebugPasses to true.");return}this._voxelRenderer.voxelDebugEnabled=e,e?this._enableEffect(this._voxelRenderer.debugPassName,this.cameras):this._disableEffect(this._voxelRenderer.debugPassName,this.cameras)}}get voxelDebugAxis(){return this._voxelRenderer?.voxelDebugAxis}set voxelDebugAxis(e){this._voxelRenderer&&(this._voxelRenderer.voxelDebugAxis=e)}set voxelDebugDisplayMip(e){this._voxelRenderer&&this._voxelRenderer.setDebugMipNumber(e)}get voxelTracingDebugEnabled(){return this._voxelTracingPass?.debugEnabled}set voxelTracingDebugEnabled(e){if(this._voxelTracingPass){if(e&&!this.allowDebugPasses){_.Warn("Can't enable voxel tracing debug view without setting allowDebugPasses to true.");return}e!==this._voxelTracingPass.debugEnabled&&(this._voxelTracingPass.debugEnabled=e,e?this._enableEffect(this._voxelTracingPass.debugPassName,this.cameras):this._disableEffect(this._voxelTracingPass.debugPassName,this.cameras))}}get spatialBlurPassDebugEnabled(){return this._spatialBlurPass.debugEnabled}set spatialBlurPassDebugEnabled(e){if(this._spatialBlurPass){if(e&&!this.allowDebugPasses){_.Warn("Can't enable spatial blur debug view without setting allowDebugPasses to true.");return}e!==this._spatialBlurPass.debugEnabled&&(this._spatialBlurPass.debugEnabled=e,e?this._enableEffect(this._spatialBlurPass.debugPassName,this.cameras):this._disableEffect(this._spatialBlurPass.debugPassName,this.cameras))}}get accumulationPassDebugEnabled(){return this._accumulationPass?.debugEnabled}set accumulationPassDebugEnabled(e){if(this._accumulationPass){if(e&&!this.allowDebugPasses){_.Warn("Can't enable accumulation pass debug view without setting allowDebugPasses to true.");return}e!==this._accumulationPass.debugEnabled&&(this._accumulationPass.debugEnabled=e,e?this._enableEffect(this._accumulationPass.debugPassName,this.cameras):this._disableEffect(this._accumulationPass.debugPassName,this.cameras))}}addShadowCastingMesh(e){if(Array.isArray(e))for(const t of e)t&&this._shadowCastingMeshes.indexOf(t)===-1&&this._shadowCastingMeshes.push(t);else e&&this._shadowCastingMeshes.indexOf(e)===-1&&this._shadowCastingMeshes.push(e)}removeShadowCastingMesh(e){if(Array.isArray(e))for(const t of e){const s=this._shadowCastingMeshes.indexOf(t);s!==-1&&this._shadowCastingMeshes.splice(s,1)}else{const t=this._shadowCastingMeshes.indexOf(e);t!==-1&&this._shadowCastingMeshes.splice(t,1)}}clearShadowCastingMeshes(){this._shadowCastingMeshes.length=0}get resolutionExp(){return this._voxelRenderer.voxelResolutionExp}set resolutionExp(e){if(e!==this._voxelRenderer.voxelResolutionExp){if(this._voxelRenderer.isVoxelizationInProgress()){_.Warn("Can't change the resolution of the voxel grid while voxelization is in progress.");return}this._voxelRenderer.voxelResolutionExp=Math.max(1,Math.min(e,8)),this._accumulationPass.reset=!0}}get sampleDirections(){return this._voxelTracingPass?.sampleDirections}set sampleDirections(e){this._voxelTracingPass&&(this._voxelTracingPass.sampleDirections=e)}get shadowRemanence(){return this._accumulationPass?.remanence}set shadowRemanence(e){this._accumulationPass&&(this._accumulationPass.remanence=e)}get envRotation(){return this._voxelTracingPass?.envRotation}set envRotation(e){this._voxelTracingPass&&(this._voxelTracingPass.envRotation=e,this._accumulationPass.reset=!0)}get allowDebugPasses(){return this._allowDebugPasses}set allowDebugPasses(e){this._allowDebugPasses!==e&&(this._allowDebugPasses=e,e&&this.scene.iblCdfGenerator?this.scene.iblCdfGenerator.isReady()?this._createDebugPasses():this.scene.iblCdfGenerator.onGeneratedObservable.addOnce(()=>{this._createDebugPasses()}):this._disposeDebugPasses())}static get IsSupported(){const e=Y.LastCreatedEngine;return e?e._features.supportIBLShadows:!1}toggleShadow(e){this._enabled=e,this._voxelTracingPass.enabled=e,this._spatialBlurPass.enabled=e,this._accumulationPass.enabled=e;for(const t of this._materialsWithRenderPlugin)if(t.pluginManager){const s=t.pluginManager.getPlugin(c.Name);s.isEnabled=e}this._setPluginParameters()}updateVoxelization(){if(this._shadowCastingMeshes.length===0){_.Warn("IBL Shadows: updateVoxelization called with no shadow-casting meshes to voxelize.");return}this._voxelRenderer.updateVoxelGrid(this._shadowCastingMeshes),this._voxelRenderer.onVoxelizationCompleteObservable.addOnce(()=>{this.onVoxelizationCompleteObservable.notifyObservers()}),this._updateSsShadowParams()}updateSceneBounds(){const e={min:new g(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),max:new g(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE)};for(const a of this._shadowCastingMeshes){const l=a.getHierarchyBoundingVectors(!0);e.min=g.Minimize(e.min,l.min),e.max=g.Maximize(e.max,l.max)}const t=e.max.subtract(e.min);if(this.voxelGridSize=Math.max(t.x,t.y,t.z),this._shadowCastingMeshes.length===0||!isFinite(this.voxelGridSize)||this.voxelGridSize===0){_.Warn("IBL Shadows: Scene size is invalid. Can't update bounds."),this.voxelGridSize=1;return}const s=this.voxelGridSize/2,i=e.max.add(e.min).multiplyByFloats(-.5,-.5,-.5),n=b.Compose(new g(1/s,1/s,1/s),new I,new g(0,0,0));b.Compose(new g(1,1,1),new I,i).multiplyToRef(n,n),this._voxelTracingPass.setWorldScaleMatrix(n),this._voxelRenderer.setWorldScaleMatrix(n),this._spatialBlurPass.setWorldScale(s*2),this._updateSsShadowParams()}constructor(e,t,s={},i){super(t.getEngine(),e),this._allowDebugPasses=!1,this._debugPasses=[],this._shadowCastingMeshes=[],this._shadowOpacity=.8,this._enabled=!0,this._coloredShadows=!1,this._materialsWithRenderPlugin=[],this.onShadowTextureReadyObservable=new R,this.onNewIblReadyObservable=new R,this.onVoxelizationCompleteObservable=new R,this.voxelGridSize=1,this._renderSizeFactor=1,this._gbufferDebugEnabled=!1,this._gBufferDebugSizeParams=new f(0,0,0,0),this.scene=t,this._cameras=i||[t.activeCamera];const n=new Uint8Array([0,0,0,255]);this._dummyTexture2d=new q(n,1,1,D.TEXTUREFORMAT_RGBA,t,!1),this._dummyTexture3d=new te(n,1,1,1,D.TEXTUREFORMAT_RGBA,t,!1);const r={};r[d.SCREENSPACE_DEPTH_TEXTURE_TYPE]={textureFormat:6,textureType:1},r[d.VELOCITY_LINEAR_TEXTURE_TYPE]={textureFormat:7,textureType:2},r[d.POSITION_TEXTURE_TYPE]={textureFormat:5,textureType:2},r[d.NORMAL_TEXTURE_TYPE]={textureFormat:5,textureType:2};const a=t.enableGeometryBufferRenderer(void 0,14,r);if(!a){_.Error("Geometry buffer renderer is required for IBL shadows to work.");return}this._geometryBufferRenderer=a,this._geometryBufferRenderer.enableScreenspaceDepth=!0,this._geometryBufferRenderer.enableVelocityLinear=!0,this._geometryBufferRenderer.enablePosition=!0,this._geometryBufferRenderer.enableNormal=!0,this._geometryBufferRenderer.generateNormalsInWorldSpace=!0,this.scene.enableIblCdfGenerator(),this.shadowOpacity=s.shadowOpacity||.8,this._voxelRenderer=new K(this.scene,this,s?s.resolutionExp:6,s.triPlanarVoxelization!==void 0?s.triPlanarVoxelization:!0),this._voxelTracingPass=new J(this.scene,this),this._spatialBlurPass=new $(this.scene,this),this._accumulationPass=new ee(this.scene,this),this._accumulationPass.onReadyObservable.addOnce(()=>{this.onShadowTextureReadyObservable.notifyObservers()}),this.sampleDirections=s.sampleDirections||2,this.voxelShadowOpacity=s.voxelShadowOpacity??1,this.envRotation=s.envRotation??0,this.shadowRenderSizeFactor=s.shadowRenderSizeFactor||1,this.ssShadowOpacity=s.ssShadowsEnabled===void 0||s.ssShadowsEnabled?1:0,this.ssShadowDistanceScale=s.ssShadowDistanceScale||1.25,this.ssShadowSampleCount=s.ssShadowSampleCount||16,this.ssShadowStride=s.ssShadowStride||8,this.ssShadowThicknessScale=s.ssShadowThicknessScale||1,this.shadowRemanence=s.shadowRemanence??.75,this._noiseTexture=new x("https://assets.babylonjs.com/textures/blue_noise/blue_noise_rgb.png",this.scene,!1,!0,1),t.postProcessRenderPipelineManager.addPipeline(this),this.scene.onActiveCameraChanged.add(this._listenForCameraChanges.bind(this)),this.scene.onBeforeRenderObservable.add(this._updateBeforeRender.bind(this)),this._listenForCameraChanges(),this.scene.getEngine().onResizeObservable.add(this._handleResize.bind(this)),this.scene.iblCdfGenerator&&this.scene.iblCdfGenerator.onGeneratedObservable.add(()=>{this._setPluginParameters(),this.onNewIblReadyObservable.notifyObservers()})}_handleResize(){this._voxelRenderer.resize(),this._voxelTracingPass.resize(this.shadowRenderSizeFactor),this._spatialBlurPass.resize(this.shadowRenderSizeFactor),this._accumulationPass.resize(this.shadowRenderSizeFactor),this._setPluginParameters()}_getGBufferDebugPass(){if(this._gbufferDebugPass)return this._gbufferDebugPass;const e=this.engine.isWebGPU,t=["depthSampler","normalSampler","positionSampler","velocitySampler"],s={width:this.scene.getEngine().getRenderWidth(),height:this.scene.getEngine().getRenderHeight(),samplingMode:1,engine:this.scene.getEngine(),textureType:0,textureFormat:5,uniforms:["sizeParams"],samplers:t,reusable:!1,shaderLanguage:e?1:0,extraInitializations:(i,n)=>{i?n.push(o(()=>import("./iblShadowGBufferDebug.fragment-Da0lwYuA.js"),__vite__mapDeps([30,1,2,3]),import.meta.url)):n.push(o(()=>import("./iblShadowGBufferDebug.fragment-DWk7EThh.js"),__vite__mapDeps([31,1,2,3]),import.meta.url))}};return this._gbufferDebugPass=new w("iblShadowGBufferDebug","iblShadowGBufferDebug",s),this.engine.isWebGPU&&(this._gbufferDebugPass.samples=this.engine.currentSampleCount??1),this._gbufferDebugPass.autoClear=!1,this._gbufferDebugPass.onApplyObservable.add(i=>{const n=this._geometryBufferRenderer.getTextureIndex(d.SCREENSPACE_DEPTH_TEXTURE_TYPE);i.setTexture("depthSampler",this._geometryBufferRenderer.getGBuffer().textures[n]);const r=this._geometryBufferRenderer.getTextureIndex(d.NORMAL_TEXTURE_TYPE);i.setTexture("normalSampler",this._geometryBufferRenderer.getGBuffer().textures[r]);const a=this._geometryBufferRenderer.getTextureIndex(d.POSITION_TEXTURE_TYPE);i.setTexture("positionSampler",this._geometryBufferRenderer.getGBuffer().textures[a]);const l=this._geometryBufferRenderer.getTextureIndex(d.VELOCITY_LINEAR_TEXTURE_TYPE);i.setTexture("velocitySampler",this._geometryBufferRenderer.getGBuffer().textures[l]),i.setVector4("sizeParams",this._gBufferDebugSizeParams),this.scene.activeCamera&&i.setFloat("maxDepth",this.scene.activeCamera.maxZ)}),this._gbufferDebugPass}_createDebugPasses(){this.scene.iblCdfGenerator?this._debugPasses=[{pass:this.scene.iblCdfGenerator.getDebugPassPP(),enabled:this.cdfDebugEnabled}]:this._debugPasses=[],this._debugPasses.push({pass:this._voxelRenderer.getDebugPassPP(),enabled:this.voxelDebugEnabled},{pass:this._voxelTracingPass.getDebugPassPP(),enabled:this.voxelTracingDebugEnabled},{pass:this._spatialBlurPass.getDebugPassPP(),enabled:this.spatialBlurPassDebugEnabled},{pass:this._accumulationPass.getDebugPassPP(),enabled:this.accumulationPassDebugEnabled},{pass:this._getGBufferDebugPass(),enabled:this.gbufferDebugEnabled});for(let t=0;t<this._debugPasses.length;t++)this._debugPasses[t].pass&&this.addEffect(new j(this.scene.getEngine(),this._debugPasses[t].pass.name,()=>this._debugPasses[t].pass,!0));const e=this.cameras.slice();this.scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this.name,this.cameras),this.scene.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(this.name,e);for(let t=0;t<this._debugPasses.length;t++)this._debugPasses[t].pass&&(this._debugPasses[t].enabled?this._enableEffect(this._debugPasses[t].pass.name,this.cameras):this._disableEffect(this._debugPasses[t].pass.name,this.cameras))}_disposeEffectPasses(){this.scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this.name,this.cameras),this._disposeDebugPasses(),this._reset()}_disposeDebugPasses(){for(let e=0;e<this._debugPasses.length;e++)this._disableEffect(this._debugPasses[e].pass.name,this.cameras),this._debugPasses[e].pass.dispose();this._debugPasses=[]}_updateDebugPasses(){let e=0;this._gbufferDebugEnabled&&e++,this.cdfDebugEnabled&&e++,this.voxelDebugEnabled&&e++,this.voxelTracingDebugEnabled&&e++,this.spatialBlurPassDebugEnabled&&e++,this.accumulationPassDebugEnabled&&e++;const t=Math.ceil(Math.sqrt(e)),s=Math.ceil(e/t),i=1/s,n=1/t;let r=0,a=0;this.gbufferDebugEnabled&&(this._gBufferDebugSizeParams.set(r,a,s,t),r-=i,r<=-1&&(r=0,a-=n)),this.cdfDebugEnabled&&this.scene.iblCdfGenerator&&(this.scene.iblCdfGenerator.setDebugDisplayParams(r,a,s,t),r-=i,r<=-1&&(r=0,a-=n)),this.voxelDebugEnabled&&(this._voxelRenderer.setDebugDisplayParams(r,a,s,t),r-=i,r<=-1&&(r=0,a-=n)),this.voxelTracingDebugEnabled&&(this._voxelTracingPass.setDebugDisplayParams(r,a,s,t),r-=i,r<=-1&&(r=0,a-=n)),this.spatialBlurPassDebugEnabled&&(this._spatialBlurPass.setDebugDisplayParams(r,a,s,t),r-=i,r<=-1&&(r=0,a-=n)),this.accumulationPassDebugEnabled&&(this._accumulationPass.setDebugDisplayParams(r,a,s,t),r-=i,r<=-1&&(r=0,a-=n))}_updateSsShadowParams(){this._voxelTracingPass.sssMaxDist=this._sssMaxDistScale*this.voxelGridSize/(1<<this.resolutionExp),this._voxelTracingPass.sssThickness=this._sssThicknessScale*.005*this.voxelGridSize}addShadowReceivingMaterial(e){if(e)if(Array.isArray(e))for(const t of e)this._addShadowSupportToMaterial(t);else this._addShadowSupportToMaterial(e);else for(const t of this.scene.materials)this._addShadowSupportToMaterial(t)}removeShadowReceivingMaterial(e){if(Array.isArray(e))for(const t of e){const s=this._materialsWithRenderPlugin.indexOf(t);if(s!==-1){this._materialsWithRenderPlugin.splice(s,1);const i=t.pluginManager?.getPlugin(c.Name);i.isEnabled=!1}}else{const t=this._materialsWithRenderPlugin.indexOf(e);if(t!==-1){this._materialsWithRenderPlugin.splice(t,1);const s=e.pluginManager.getPlugin(c.Name);s.isEnabled=!1}}}clearShadowReceivingMaterials(){for(const e of this._materialsWithRenderPlugin){const t=e.pluginManager?.getPlugin(c.Name);t&&(t.isEnabled=!1)}this._materialsWithRenderPlugin.length=0}_addShadowSupportToMaterial(e){if(!(e instanceof y)&&!(e instanceof Q)&&!(e instanceof M))return;let t=e.pluginManager?.getPlugin(c.Name);t||(t=new c(e)),this._materialsWithRenderPlugin.indexOf(e)===-1&&(this._enabled&&(t.iblShadowsTexture=this._getAccumulatedTexture().getInternalTexture(),t.shadowOpacity=this.shadowOpacity),t.isEnabled=this._enabled,t.isColored=this._coloredShadows,this._materialsWithRenderPlugin.push(e))}_setPluginParameters(){if(this._enabled){for(const e of this._materialsWithRenderPlugin)if(e.pluginManager){const t=e.pluginManager.getPlugin(c.Name);t.iblShadowsTexture=this._getAccumulatedTexture().getInternalTexture(),t.shadowOpacity=this.shadowOpacity,t.isColored=this._coloredShadows}}}_updateBeforeRender(){this._updateDebugPasses()}_listenForCameraChanges(){this.scene.activeCamera?.onViewMatrixChangedObservable.add(()=>{this._accumulationPass.isMoving=!0})}isReady(){return this._noiseTexture.isReady()&&this._voxelRenderer.isReady()&&this.scene.iblCdfGenerator&&this.scene.iblCdfGenerator.isReady()&&(!this._voxelTracingPass||this._voxelTracingPass.isReady())&&(!this._spatialBlurPass||this._spatialBlurPass.isReady())&&(!this._accumulationPass||this._accumulationPass.isReady())}getClassName(){return"IBLShadowsRenderPipeline"}dispose(){const e=this._materialsWithRenderPlugin.splice(0);for(const t of e)this.removeShadowReceivingMaterial(t);this._disposeEffectPasses(),this._noiseTexture.dispose(),this._voxelRenderer.dispose(),this._voxelTracingPass.dispose(),this._spatialBlurPass.dispose(),this._accumulationPass.dispose(),this._dummyTexture2d.dispose(),this._dummyTexture3d.dispose(),this.onNewIblReadyObservable.clear(),this.onShadowTextureReadyObservable.clear(),this.onVoxelizationCompleteObservable.clear(),super.dispose()}}export{Ge as IblShadowsRenderPipeline};
